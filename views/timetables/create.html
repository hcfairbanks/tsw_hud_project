<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Timetable</title>
    <link rel="stylesheet" href="/css/theme.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@7.0.0/css/flag-icons.min.css">
    <script src="/js/theme-loader.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-primary); color: var(--text-primary); padding: 20px; transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 1600px; margin: 0 auto; }
        h1 { color: var(--accent-color); margin-bottom: 30px; text-align: center; }
        .form-section { background: var(--bg-secondary); padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; border: 1px solid var(--border-color); }
        .form-section h2 { font-size: 16px; color: var(--accent-color); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--accent-color); }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        .form-group { flex: 1; min-width: 200px; }
        .form-group.full-width { flex: 100%; }
        .form-group label { display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; background: var(--bg-primary); color: var(--text-primary); }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--accent-color); }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; }
        .btn-primary { background: var(--btn-primary-bg); color: white; }
        .btn-primary:hover { background: var(--btn-primary-hover); }
        .btn-success { background: var(--color-success); color: white; }
        .btn-success:hover { opacity: 0.9; }
        .btn-danger { background: var(--btn-danger-bg); color: white; }
        .btn-danger:hover { background: var(--btn-danger-hover); }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); }
        .btn-secondary:hover { background: var(--accent-hover); }
        .entries-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .entries-header h2 { margin-bottom: 0; border-bottom: none; padding-bottom: 0; }
        .entries-table { width: 100%; border-collapse: collapse; }
        .entries-table th, .entries-table td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 13px; }
        .entries-table th { background: var(--bg-tertiary); font-weight: 600; color: var(--accent-color); }
        .entries-table input, .entries-table select { width: 100%; padding: 6px 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 12px; background: var(--bg-primary); color: var(--text-primary); }
        .entries-table .action-select { min-width: 140px; }
        .entries-table .location-input { min-width: 150px; }
        .entries-table .platform-input { width: 60px; }
        .entries-table .time-input { width: 90px; }
        .entries-table .btn-small { padding: 4px 8px; font-size: 12px; }
        .entries-table .actions-cell { white-space: nowrap; }
        .no-entries { text-align: center; padding: 40px; color: var(--text-muted); font-style: italic; }
        .submit-section { display: flex; gap: 10px; justify-content: flex-end; }
        .status-message { padding: 15px; border-radius: 4px; margin-bottom: 20px; display: none; }
        .status-message.success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; display: block; }
        .status-message.error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; display: block; }
        .quick-add { background: var(--bg-tertiary); padding: 15px; border-radius: 6px; margin-bottom: 15px; }
        .quick-add h3 { font-size: 14px; color: var(--text-primary); margin-bottom: 10px; }
        .quick-add-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        .quick-add-buttons .btn { padding: 6px 12px; font-size: 12px; }

        /* Typeahead styles */
        .typeahead-wrapper { position: relative; flex: 1; }
        .typeahead-input { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary); font-size: 14px; }
        .typeahead-input:focus { outline: none; border-color: var(--accent-color); }
        .typeahead-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-primary); border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto; z-index: 100; display: none; }
        .typeahead-dropdown.show { display: block; }
        .typeahead-item { padding: 10px; cursor: pointer; color: var(--text-primary); }
        .typeahead-item:hover, .typeahead-item.active { background: var(--bg-tertiary); color: var(--accent-color); }
        .typeahead-empty { padding: 10px; color: var(--text-muted); font-style: italic; }
        .typeahead-row { display: flex; align-items: center; gap: 10px; }
        .clear-btn { padding: 5px 10px; font-size: 12px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; }
        .clear-btn:hover { background: var(--btn-danger-bg); color: #fff; }

        /* Selected trains list */
        .selected-trains { margin-top: 10px; }
        .selected-train { display: inline-flex; align-items: center; gap: 5px; background: var(--bg-tertiary); padding: 5px 10px; border-radius: 4px; margin-right: 8px; margin-bottom: 8px; font-size: 13px; }
        .selected-train .remove-train { background: none; border: none; color: var(--btn-danger-bg); cursor: pointer; font-size: 14px; padding: 0 2px; }
        .selected-train .remove-train:hover { color: var(--btn-danger-hover); }
    </style>
</head>
<body data-theme="dark">
    <script src="/js/i18n.js"></script>
    <div class="container">
        <h1 data-i18n="timetables.createNew">Create Timetable</h1>
        <nav id="main-nav"></nav>

        <div id="statusMessage" class="status-message"></div>

        <div class="form-section">
            <h2 data-i18n="timetables.details">Timetable Details</h2>
            <div class="form-row">
                <div class="form-group full-width">
                    <label for="serviceName" data-i18n="timetables.serviceName">Service Name *</label>
                    <input type="text" id="serviceName" placeholder="e.g., 2T17: London Euston - Tring 08:22 00:35" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label data-i18n="timetables.route">Route *</label>
                    <div class="typeahead-row">
                        <div class="typeahead-wrapper">
                            <input type="text" class="typeahead-input" id="routeSearch" data-i18n-placeholder="trains.searchRoutesPlaceholder" placeholder="Type to search routes..." autocomplete="off">
                            <div class="typeahead-dropdown" id="routeDropdown"></div>
                        </div>
                        <button type="button" class="clear-btn" onclick="clearRoute()" data-i18n="common.clear">Clear</button>
                    </div>
                </div>
                <div class="form-group">
                    <label data-i18n="timetables.trains">Trains * (at least one)</label>
                    <div class="typeahead-row">
                        <div class="typeahead-wrapper">
                            <input type="text" class="typeahead-input" id="trainSearch" placeholder="Type to search and add trains..." autocomplete="off">
                            <div class="typeahead-dropdown" id="trainDropdown"></div>
                        </div>
                    </div>
                    <div class="selected-trains" id="selectedTrains"></div>
                </div>
            </div>
        </div>

        <div class="form-section">
            <div class="entries-header">
                <h2 data-i18n="timetables.entries">Timetable Entries</h2>
                <button class="btn btn-primary" onclick="addEntry()" data-i18n="timetables.addEntry">+ Add Entry</button>
            </div>

            <div class="quick-add">
                <h3 data-i18n="timetables.quickAdd">Quick Add Common Entries</h3>
                <div class="quick-add-buttons">
                    <button class="btn btn-secondary" onclick="addQuickEntry('WAIT FOR SERVICE')">Wait for Service</button>
                    <button class="btn btn-secondary" onclick="addQuickEntry('STOP AT LOCATION')">Stop at Location</button>
                    <button class="btn btn-secondary" onclick="addQuickEntry('LOAD PASSENGERS')">Load Passengers</button>
                    <button class="btn btn-secondary" onclick="addQuickEntry('UNLOAD PASSENGERS')">Unload Passengers</button>
                    <button class="btn btn-secondary" onclick="addQuickEntry('GO VIA LOCATION')">Go Via Location</button>
                </div>
            </div>

            <table class="entries-table" id="entriesTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th data-i18n="timetables.action">Action</th>
                        <th data-i18n="timetables.location">Location</th>
                        <th data-i18n="timetables.platform">Platform</th>
                        <th data-i18n="timetables.time1">Time 1</th>
                        <th data-i18n="timetables.time2">Time 2</th>
                        <th data-i18n="common.actions">Actions</th>
                    </tr>
                </thead>
                <tbody id="entriesBody">
                </tbody>
            </table>

            <div id="noEntries" class="no-entries">
                No entries yet. Click "Add Entry" or use Quick Add to start building your timetable.
            </div>
        </div>

        <div class="form-section submit-section">
            <button class="btn btn-secondary" onclick="clearAll()" data-i18n="common.clear">Clear All</button>
            <button class="btn btn-success" onclick="createTimetable()" data-i18n="timetables.createNew">Create Timetable</button>
        </div>
    </div>

    <script>
        let entries = [];
        let entryIdCounter = 0;
        let allRoutes = [];
        let allTrains = [];
        let routeTrains = []; // Trains available for the selected route
        let selectedRouteId = null;
        let selectedTrains = []; // Array of {id, name}
        let routeActiveIndex = -1;
        let trainActiveIndex = -1;

        const ACTIONS = [
            'WAIT FOR SERVICE',
            'STOP AT LOCATION',
            'LOAD PASSENGERS',
            'UNLOAD PASSENGERS',
            'GO VIA LOCATION',
            'UNCOUPLE VEHICLES',
            'COUPLE TO FORMATION'
        ];

        // Load routes and trains
        async function loadRoutes() {
            try {
                const response = await fetch('/api/routes');
                allRoutes = await response.json();
            } catch (err) {
                console.error('Failed to load routes:', err);
            }
        }

        async function loadTrains() {
            try {
                const response = await fetch('/api/trains');
                allTrains = await response.json();
            } catch (err) {
                console.error('Failed to load trains:', err);
            }
        }

        // Route typeahead
        function filterRoutes(query) {
            if (!query) return allRoutes.slice(0, 10);
            const lowerQuery = query.toLowerCase();
            return allRoutes.filter(function(r) {
                return r.name.toLowerCase().includes(lowerQuery);
            }).slice(0, 10);
        }

        function renderRouteDropdown(routes) {
            const dropdown = document.getElementById('routeDropdown');
            if (routes.length === 0) {
                dropdown.innerHTML = '<div class="typeahead-empty">No routes found</div>';
            } else {
                dropdown.innerHTML = routes.map(function(route, index) {
                    return '<div class="typeahead-item' + (index === routeActiveIndex ? ' active' : '') + '" data-id="' + route.id + '" data-name="' + escapeHtml(route.name) + '">' + escapeHtml(route.name) + '</div>';
                }).join('');

                dropdown.querySelectorAll('.typeahead-item').forEach(function(item) {
                    item.addEventListener('click', function() {
                        selectRoute(parseInt(item.dataset.id), item.dataset.name);
                    });
                });
            }
            dropdown.classList.add('show');
        }

        async function selectRoute(id, name) {
            document.getElementById('routeSearch').value = name;
            selectedRouteId = id;
            document.getElementById('routeDropdown').classList.remove('show');
            routeActiveIndex = -1;

            // Clear selected trains when route changes (they may not be valid for new route)
            selectedTrains = [];
            renderSelectedTrains();

            // Fetch trains available for this route
            try {
                const response = await fetch('/api/routes/' + id + '/trains');
                routeTrains = await response.json();
            } catch (err) {
                console.error('Failed to load trains for route:', err);
                routeTrains = [];
            }

            // Enable train input and update placeholder
            const trainInput = document.getElementById('trainSearch');
            trainInput.disabled = false;
            trainInput.placeholder = routeTrains.length > 0
                ? 'Type to search and add trains...'
                : 'No trains available for this route';
        }

        function clearRoute() {
            document.getElementById('routeSearch').value = '';
            selectedRouteId = null;
            routeTrains = [];

            // Clear selected trains since no route is selected
            selectedTrains = [];
            renderSelectedTrains();

            // Disable train input until a route is selected
            const trainInput = document.getElementById('trainSearch');
            trainInput.disabled = true;
            trainInput.placeholder = 'Select a route first...';
            trainInput.value = '';
        }

        function setupRouteTypeahead() {
            const searchInput = document.getElementById('routeSearch');
            const dropdown = document.getElementById('routeDropdown');

            searchInput.addEventListener('input', function() {
                selectedRouteId = null;
                routeActiveIndex = -1;
                const filtered = filterRoutes(searchInput.value.trim());
                renderRouteDropdown(filtered);
            });

            searchInput.addEventListener('focus', function() {
                const filtered = filterRoutes(searchInput.value.trim());
                renderRouteDropdown(filtered);
            });

            searchInput.addEventListener('keydown', function(e) {
                const items = dropdown.querySelectorAll('.typeahead-item');
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    routeActiveIndex = Math.min(routeActiveIndex + 1, items.length - 1);
                    updateActiveItem(items, routeActiveIndex);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    routeActiveIndex = Math.max(routeActiveIndex - 1, 0);
                    updateActiveItem(items, routeActiveIndex);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (routeActiveIndex >= 0 && items[routeActiveIndex]) {
                        selectRoute(parseInt(items[routeActiveIndex].dataset.id), items[routeActiveIndex].dataset.name);
                    }
                } else if (e.key === 'Escape') {
                    dropdown.classList.remove('show');
                    routeActiveIndex = -1;
                }
            });
        }

        // Train typeahead (multi-select) - filtered by selected route
        function filterTrains(query) {
            // Only show trains available for the selected route
            if (!selectedRouteId || routeTrains.length === 0) {
                return [];
            }

            // Filter out already selected trains
            const selectedIds = selectedTrains.map(function(t) { return t.id; });
            let available = routeTrains.filter(function(t) {
                return !selectedIds.includes(t.id);
            });

            if (!query) return available.slice(0, 10);
            const lowerQuery = query.toLowerCase();
            return available.filter(function(t) {
                return t.name.toLowerCase().includes(lowerQuery);
            }).slice(0, 10);
        }

        function renderTrainDropdown(trains) {
            const dropdown = document.getElementById('trainDropdown');
            if (!selectedRouteId) {
                dropdown.innerHTML = '<div class="typeahead-empty">Please select a route first</div>';
            } else if (trains.length === 0) {
                dropdown.innerHTML = '<div class="typeahead-empty">No trains available for this route</div>';
            } else {
                dropdown.innerHTML = trains.map(function(train, index) {
                    let label = escapeHtml(train.name);
                    if (train.class_name) {
                        label += ' <span style="color: var(--text-muted);">(' + escapeHtml(train.class_name) + ')</span>';
                    }
                    return '<div class="typeahead-item' + (index === trainActiveIndex ? ' active' : '') + '" data-id="' + train.id + '" data-name="' + escapeHtml(train.name) + '">' + label + '</div>';
                }).join('');

                dropdown.querySelectorAll('.typeahead-item').forEach(function(item) {
                    item.addEventListener('click', function() {
                        addTrain(parseInt(item.dataset.id), item.dataset.name);
                    });
                });
            }
            dropdown.classList.add('show');
        }

        function addTrain(id, name) {
            // Check if already added
            if (selectedTrains.some(function(t) { return t.id === id; })) return;

            selectedTrains.push({ id: id, name: name });
            document.getElementById('trainSearch').value = '';
            document.getElementById('trainDropdown').classList.remove('show');
            trainActiveIndex = -1;
            renderSelectedTrains();
        }

        function removeTrain(id) {
            selectedTrains = selectedTrains.filter(function(t) { return t.id !== id; });
            renderSelectedTrains();
        }

        function renderSelectedTrains() {
            const container = document.getElementById('selectedTrains');
            if (selectedTrains.length === 0) {
                container.innerHTML = '';
                return;
            }
            container.innerHTML = selectedTrains.map(function(train) {
                return '<span class="selected-train">' + escapeHtml(train.name) + '<button type="button" class="remove-train" onclick="removeTrain(' + train.id + ')">&times;</button></span>';
            }).join('');
        }

        function setupTrainTypeahead() {
            const searchInput = document.getElementById('trainSearch');
            const dropdown = document.getElementById('trainDropdown');

            searchInput.addEventListener('input', function() {
                trainActiveIndex = -1;
                const filtered = filterTrains(searchInput.value.trim());
                renderTrainDropdown(filtered);
            });

            searchInput.addEventListener('focus', function() {
                const filtered = filterTrains(searchInput.value.trim());
                renderTrainDropdown(filtered);
            });

            searchInput.addEventListener('keydown', function(e) {
                const items = dropdown.querySelectorAll('.typeahead-item');
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    trainActiveIndex = Math.min(trainActiveIndex + 1, items.length - 1);
                    updateActiveItem(items, trainActiveIndex);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    trainActiveIndex = Math.max(trainActiveIndex - 1, 0);
                    updateActiveItem(items, trainActiveIndex);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (trainActiveIndex >= 0 && items[trainActiveIndex]) {
                        addTrain(parseInt(items[trainActiveIndex].dataset.id), items[trainActiveIndex].dataset.name);
                    }
                } else if (e.key === 'Escape') {
                    dropdown.classList.remove('show');
                    trainActiveIndex = -1;
                }
            });
        }

        function updateActiveItem(items, activeIndex) {
            items.forEach(function(item, index) {
                if (index === activeIndex) {
                    item.classList.add('active');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.typeahead-wrapper')) {
                document.getElementById('routeDropdown').classList.remove('show');
                document.getElementById('trainDropdown').classList.remove('show');
                routeActiveIndex = -1;
                trainActiveIndex = -1;
            }
        });

        function addEntry(action = '') {
            const entry = {
                id: ++entryIdCounter,
                action: action,
                location: '',
                platform: '',
                time1: '',
                time2: ''
            };
            entries.push(entry);
            renderEntries();
        }

        function addQuickEntry(action) {
            addEntry(action);
        }

        function removeEntry(id) {
            entries = entries.filter(e => e.id !== id);
            renderEntries();
        }

        function moveEntryUp(id) {
            const index = entries.findIndex(e => e.id === id);
            if (index > 0) {
                [entries[index - 1], entries[index]] = [entries[index], entries[index - 1]];
                renderEntries();
            }
        }

        function moveEntryDown(id) {
            const index = entries.findIndex(e => e.id === id);
            if (index < entries.length - 1) {
                [entries[index], entries[index + 1]] = [entries[index + 1], entries[index]];
                renderEntries();
            }
        }

        function updateEntry(id, field, value) {
            const entry = entries.find(e => e.id === id);
            if (entry) {
                entry[field] = value;
            }
        }

        function renderEntries() {
            const tbody = document.getElementById('entriesBody');
            const noEntries = document.getElementById('noEntries');

            if (entries.length === 0) {
                tbody.innerHTML = '';
                noEntries.style.display = 'block';
                return;
            }

            noEntries.style.display = 'none';

            tbody.innerHTML = entries.map((entry, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>
                        <select class="action-select" onchange="updateEntry(${entry.id}, 'action', this.value)">
                            <option value="">-- Select --</option>
                            ${ACTIONS.map(a => `<option value="${a}" ${entry.action === a ? 'selected' : ''}>${a}</option>`).join('')}
                        </select>
                    </td>
                    <td>
                        <input type="text" class="location-input" value="${escapeHtml(entry.location)}"
                            onchange="updateEntry(${entry.id}, 'location', this.value)"
                            placeholder="Station name">
                    </td>
                    <td>
                        <input type="text" class="platform-input" value="${escapeHtml(entry.platform)}"
                            onchange="updateEntry(${entry.id}, 'platform', this.value)"
                            placeholder="Plat">
                    </td>
                    <td>
                        <input type="text" class="time-input" value="${escapeHtml(entry.time1)}"
                            onchange="updateEntry(${entry.id}, 'time1', formatTimeInput(this.value)); this.value = formatTimeInput(this.value);"
                            pattern="^([0-1]?[0-9]|2[0-3]):([0-5][0-9]):([0-5][0-9])$"
                            title="Time format: HH:MM:SS (e.g., 08:30:00)"
                            placeholder="00:00:00">
                    </td>
                    <td>
                        <input type="text" class="time-input" value="${escapeHtml(entry.time2)}"
                            onchange="updateEntry(${entry.id}, 'time2', formatTimeInput(this.value)); this.value = formatTimeInput(this.value);"
                            pattern="^([0-1]?[0-9]|2[0-3]):([0-5][0-9]):([0-5][0-9])$"
                            title="Time format: HH:MM:SS (e.g., 08:30:00)"
                            placeholder="00:00:00">
                    </td>
                    <td class="actions-cell">
                        <button class="btn btn-secondary btn-small" onclick="moveEntryUp(${entry.id})" ${index === 0 ? 'disabled' : ''}>&#8593;</button>
                        <button class="btn btn-secondary btn-small" onclick="moveEntryDown(${entry.id})" ${index === entries.length - 1 ? 'disabled' : ''}>&#8595;</button>
                        <button class="btn btn-danger btn-small" onclick="removeEntry(${entry.id})">&times;</button>
                    </td>
                </tr>
            `).join('');
        }

        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Validate time format HH:MM:SS (00:00:00 - 23:59:59)
        function isValidTimeFormat(time) {
            if (!time) return true; // Empty is allowed (optional field)
            const pattern = /^([0-1]?[0-9]|2[0-3]):([0-5][0-9]):([0-5][0-9])$/;
            return pattern.test(time);
        }

        // Format time input to HH:MM:SS
        function formatTimeInput(value) {
            if (!value) return '';
            // If already in correct format, return as-is
            if (/^([0-1]?[0-9]|2[0-3]):([0-5][0-9]):([0-5][0-9])$/.test(value)) {
                // Pad hours if needed
                const parts = value.split(':');
                return parts[0].padStart(2, '0') + ':' + parts[1] + ':' + parts[2];
            }
            return value;
        }

        function showStatus(message, isError = false) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = 'status-message ' + (isError ? 'error' : 'success');
            window.scrollTo(0, 0);
        }

        function clearAll() {
            if (!confirm('Clear all entries and start over?')) return;
            entries = [];
            entryIdCounter = 0;
            selectedTrains = [];
            selectedRouteId = null;
            routeTrains = [];
            document.getElementById('serviceName').value = '';
            document.getElementById('routeSearch').value = '';
            document.getElementById('trainSearch').value = '';

            // Disable train input until a route is selected
            const trainInput = document.getElementById('trainSearch');
            trainInput.disabled = true;
            trainInput.placeholder = 'Select a route first...';

            renderSelectedTrains();
            renderEntries();
        }

        async function createTimetable() {
            const serviceName = document.getElementById('serviceName').value.trim();

            if (!serviceName) {
                showStatus('Please enter a service name.', true);
                return;
            }

            if (entries.length === 0) {
                showStatus('Please add at least one entry.', true);
                return;
            }

            // Validate entries have actions
            const invalidEntries = entries.filter(e => !e.action);
            if (invalidEntries.length > 0) {
                showStatus('All entries must have an action selected.', true);
                return;
            }

            // Validate time format (HH:MM:SS)
            const invalidTimeEntries = entries.filter(e =>
                (e.time1 && !isValidTimeFormat(e.time1)) ||
                (e.time2 && !isValidTimeFormat(e.time2))
            );
            if (invalidTimeEntries.length > 0) {
                showStatus('Times must be in format HH:MM:SS (e.g., 08:30:00)', true);
                return;
            }

            // Build the request body
            const body = {
                service_name: serviceName,
                entries: entries.map(e => ({
                    action: e.action,
                    location: e.location,
                    platform: e.platform,
                    time1: e.time1,
                    time2: e.time2,
                    details: '',
                    latitude: '',
                    longitude: ''
                }))
            };

            if (selectedRouteId) body.route_id = selectedRouteId;
            if (selectedTrains.length > 0) {
                body.train_ids = selectedTrains.map(function(t) { return t.id; });
            }

            try {
                const response = await fetch('/api/timetables', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const result = await response.json();

                if (result.error) {
                    showStatus('Error: ' + result.error, true);
                    return;
                }

                showStatus('Timetable created successfully! Redirecting...');

                // Redirect to the new timetable
                setTimeout(() => {
                    window.location.href = `/timetables/${result.id}`;
                }, 1500);

            } catch (err) {
                console.error('Failed to create timetable:', err);
                showStatus('Failed to create timetable: ' + err.message, true);
            }
        }

        // Theme and color scheme initialization
        (function() {
            var theme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', theme);

            var colorScheme = localStorage.getItem('colorScheme');
            if (colorScheme && colorScheme !== 'default') {
                document.body.setAttribute('data-color-scheme', colorScheme);
            }
        })();

        // Initialize
        async function init() {
            await Promise.all([loadRoutes(), loadTrains()]);
            setupRouteTypeahead();
            setupTrainTypeahead();
            renderEntries();

            // Disable train input until a route is selected
            const trainInput = document.getElementById('trainSearch');
            trainInput.disabled = true;
            trainInput.placeholder = 'Select a route first...';

            // Check for URL params to pre-fill route and train
            const urlParams = new URLSearchParams(window.location.search);
            const prefilledRouteId = urlParams.get('route_id');
            const prefilledTrainId = urlParams.get('train_id');

            if (prefilledRouteId) {
                // Find the route and select it
                const route = allRoutes.find(function(r) { return r.id == prefilledRouteId; });
                if (route) {
                    await selectRoute(route.id, route.name);

                    // Now check for train if provided
                    if (prefilledTrainId) {
                        // Find the train in route trains
                        const train = routeTrains.find(function(t) { return t.id == prefilledTrainId; });
                        if (train) {
                            addTrain(train.id, train.name);
                        }
                    }
                }
            }
        }

        // Initialize after i18n is ready
        if (typeof i18n !== 'undefined' && i18n.init) {
            i18n.init().then(function() {
                init();
            });
        } else {
            init();
        }
    </script>
    <script src="/js/navbar.js"></script>
</body>
</html>
