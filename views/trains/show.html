<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Train Details - TSW HUD Project</title>
    <link rel="stylesheet" href="/css/theme.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@7.0.0/css/flag-icons.min.css">
    <script src="/js/theme-loader.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: Arial, sans-serif; max-width: 1600px; margin: 0 auto; padding: 20px; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
        h1 { color: var(--accent-color); text-align: center; margin-bottom: 30px; }
        .subtitle { text-align: center; color: var(--text-muted); margin-bottom: 30px; }
        /* Nav styles now in theme.css */
        .card { background: var(--bg-secondary); border-radius: 8px; padding: 20px; margin-bottom: 20px; border: 1px solid var(--border-color); }
        h2 { color: var(--accent-color); margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .detail-row { display: flex; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
        .detail-row:last-child { border-bottom: none; }
        .detail-label { font-weight: bold; color: var(--accent-color); width: 120px; flex-shrink: 0; }
        .detail-value { color: var(--text-primary); }
        button { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-right: 5px; }
        .btn-primary { background: var(--btn-primary-bg); color: #fff; }
        .btn-primary:hover { background: var(--btn-primary-hover); }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); }
        .btn-secondary:hover { background: var(--accent-hover); }
        .btn-danger { background: var(--btn-danger-bg); color: #fff; }
        .btn-danger:hover { background: var(--btn-danger-hover); }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background: var(--bg-tertiary); color: var(--accent-color); }
        tr:hover { background: var(--bg-primary); }
        .empty-message { text-align: center; color: var(--text-muted); padding: 20px; }
        .back-link { margin-bottom: 20px; }
        .back-link a { color: var(--accent-color); text-decoration: none; }
        .back-link a:hover { text-decoration: underline; }
        .filter-box { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
        .filter-box label { color: var(--text-secondary); white-space: nowrap; }
        .filter-box select { flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary); font-size: 14px; }
        .filter-box select:focus { outline: none; border-color: var(--accent-color); }
        .context-info { background: var(--bg-tertiary); padding: 10px 15px; border-radius: 4px; margin-bottom: 15px; color: var(--text-secondary); }
        .context-info a { color: var(--accent-color); text-decoration: none; }
        .context-info a:hover { text-decoration: underline; }
        a { color: var(--accent-color); }
        .typeahead-container { position: relative; display: block; width: 100%; }
        .typeahead-container input { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary); font-size: 14px; }
        .typeahead-container input:focus { outline: none; border-color: var(--accent-color); }
        .typeahead-dropdown { display: none; position: absolute; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; background: var(--bg-secondary); border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 4px 4px; z-index: 1001; }
        .typeahead-item { padding: 8px 12px; cursor: pointer; font-size: 13px; border-bottom: 1px solid var(--border-color); }
        .typeahead-item:last-child { border-bottom: none; }
        .typeahead-item:hover, .typeahead-item.highlighted { background: var(--bg-tertiary); }
        .typeahead-item .item-name { color: var(--text-primary); }
        .typeahead-item .item-sub { font-size: 11px; color: var(--text-muted); }
        /* Extraction module styles */
        .upload-area { border: 2px dashed var(--border-color); border-radius: 8px; padding: 30px; text-align: center; margin-bottom: 15px; cursor: pointer; transition: all 0.3s; }
        .upload-area:hover { border-color: var(--accent-color); background: var(--bg-tertiary); }
        .upload-area.dragover { border-color: var(--accent-color); background: var(--bg-tertiary); }
        .upload-area input[type="file"] { display: none; }
        .upload-icon { font-size: 48px; color: var(--border-color); margin-bottom: 10px; }
        .upload-text { color: var(--text-secondary); margin-bottom: 5px; }
        .upload-hint { color: var(--text-muted); font-size: 12px; }
        .upload-status { margin-top: 15px; padding: 10px; border-radius: 4px; display: none; }
        .upload-status.success { display: block; background: var(--color-success-bg); color: var(--color-success); }
        .upload-status.error { display: block; background: var(--color-error-bg); color: var(--color-error); }
        .upload-status.loading { display: block; background: var(--color-info-bg); color: var(--color-info); }
        .file-list { margin-top: 15px; text-align: left; }
        .file-item { display: flex; align-items: center; padding: 8px; background: var(--bg-primary); border-radius: 4px; margin-bottom: 5px; }
        .progress-bar { width: 100%; height: 20px; background: var(--bg-tertiary); border-radius: 10px; overflow: hidden; margin-top: 15px; display: none; }
        .progress-bar .fill { height: 100%; background: var(--btn-primary-bg); width: 0%; transition: width 0.3s; }
        .progress-text { text-align: center; margin-top: 10px; color: var(--text-muted); }
        .btn-success { background: var(--btn-success-bg); color: #fff; }
        .btn-success:hover { background: var(--btn-success-hover); }
        .service-name-input { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary); font-size: 14px; }
        .service-name-input:focus { outline: none; border-color: var(--accent-color); }
        .editable-cell { cursor: pointer; position: relative; }
        .editable-cell:hover { background: var(--bg-tertiary); }
        .editable-cell input { width: 100%; padding: 5px; border: 1px solid var(--accent-color); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary); font-size: 14px; }
        .action-select { padding: 6px 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary); font-size: 12px; min-width: 140px; }
        .action-select:focus { outline: none; border-color: var(--accent-color); }
        .raw-text { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; padding: 15px; margin-top: 15px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; white-space: pre-wrap; }
        .collapsible { cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .collapsible::after { content: 'â–¼'; transition: transform 0.3s; }
        .collapsible.collapsed::after { transform: rotate(-90deg); }
        .collapsible-content { display: block; }
        .collapsible-content.hidden { display: none; }
        .selected-train-tag { display: inline-flex; align-items: center; gap: 5px; background: var(--bg-tertiary); padding: 5px 10px; border-radius: 4px; margin-right: 8px; margin-bottom: 8px; font-size: 13px; }
        .selected-train-tag .remove-train { background: none; border: none; color: var(--btn-danger-bg); cursor: pointer; font-size: 14px; padding: 0 2px; }
        .selected-train-tag .remove-train:hover { color: var(--btn-danger-hover); }
    </style>
</head>
<body data-theme="dark">
    <h1 data-i18n="trains.trainDetails">Train Details</h1>

    <nav id="main-nav"></nav>

    <div class="back-link" id="backLink">
        <a href="/trains" data-i18n="trains.backToTrains">&larr; Back to Trains</a>
    </div>

    <div class="card">
        <h2 id="trainName">Loading...</h2>
        <div id="trainDetails">
            <p class="empty-message">Loading train details...</p>
        </div>
    </div>

    <div id="extractionContainer">
        <!-- Extraction module will be rendered here -->
    </div>

    <script src="/js/i18n.js"></script>
    <div class="card">
        <h2 data-i18n="nav.timetables">Timetables</h2>
        <div id="contextInfo" class="context-info" style="display:none;"></div>
        <div class="filter-box">
            <label for="routeFilterInput" data-i18n="trains.filterByRoute">Filter by Route:</label>
            <div class="typeahead-container" style="flex: 1;">
                <input type="text" id="routeFilterInput" placeholder="Type to search routes..." data-i18n-placeholder="trains.searchRoutesPlaceholder" autocomplete="off">
                <div id="routeFilterDropdown" class="typeahead-dropdown"></div>
                <input type="hidden" id="routeFilter" value="">
            </div>
            <button class="btn-secondary" onclick="clearRouteFilter()" style="padding: 10px 15px;" data-i18n="common.clear">Clear</button>
        </div>
        <div id="timetablesList">
            <p class="empty-message">Loading timetables...</p>
        </div>
    </div>

    <script>
        const trainId = window.location.pathname.split('/').pop();
        const urlParams = new URLSearchParams(window.location.search);
        const fromRouteId = urlParams.get('from_route');

        let allTimetables = [];
        let allRoutes = [];
        let currentRoute = null;

        async function loadTrain() {
            try {
                const response = await fetch('/api/trains/' + trainId);
                if (!response.ok) {
                    var notFoundTitle = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('trains.trainNotFound') : 'Train Not Found';
                    var notFoundMsg = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('trains.trainNotFoundMsg') : 'The requested train could not be found.';
                    document.getElementById('trainName').textContent = notFoundTitle;
                    document.getElementById('trainDetails').innerHTML = '<p class="empty-message">' + notFoundMsg + '</p>';
                    return;
                }
                const train = await response.json();
                renderTrain(train);
            } catch (error) {
                console.error('Error loading train:', error);
                var errorMsg = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('trains.errorLoadingTrain') : 'Error loading train';
                document.getElementById('trainDetails').innerHTML = '<p class="empty-message">' + errorMsg + '</p>';
            }
        }

        let currentTrain = null;
        let allClasses = [];

        function renderTrain(train) {
            currentTrain = train;
            document.getElementById('trainName').textContent = train.name;
            document.title = train.name + ' - TSW HUD Project';

            var idLabel = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('common.id') : 'ID';
            var nameLabel = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('common.name') : 'Name';
            var classLabel = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('trains.class') : 'Class';
            var editBtn = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('common.edit') : 'Edit';
            var saveBtn = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('common.save') : 'Save';
            var cancelBtn = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('common.cancel') : 'Cancel';
            var changeNameLabel = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('trains.changeName') : 'Change Name';
            var changeClassLabel = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('trains.changeClass') : 'Change Class';
            var namePlaceholder = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('trains.enterTrainName') : 'Enter train name...';
            var searchClassesPlaceholder = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('trains.searchClassesPlaceholder') : 'Type to search classes...';

            let classDisplay = '-';
            if (train.class_id && train.class_name) {
                classDisplay = '<a href="/train-classes/' + train.class_id + '">' + escapeHtml(train.class_name) + '</a>';
            }

            let html = '<div class="detail-row"><span class="detail-label">' + idLabel + ':</span><span class="detail-value">' + train.id + '</span></div>';
            html += '<div class="detail-row"><span class="detail-label">' + nameLabel + ':</span><span class="detail-value" id="nameDisplay">' + escapeHtml(train.name) + ' <button class="btn-secondary" style="padding: 4px 8px; font-size: 12px; margin-left: 10px;" onclick="showNameEdit()">' + editBtn + '</button></span></div>';
            html += '<div class="detail-row" id="nameEditRow" style="display: none;"><span class="detail-label">' + changeNameLabel + ':</span><span class="detail-value"><input type="text" id="nameInput" style="padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary); font-size: 14px; min-width: 200px;" placeholder="' + namePlaceholder + '"> <button class="btn-primary" style="padding: 4px 12px; font-size: 12px;" onclick="saveNameChange()">' + saveBtn + '</button> <button class="btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="cancelNameEdit()">' + cancelBtn + '</button></span></div>';
            html += '<div class="detail-row"><span class="detail-label">' + classLabel + ':</span><span class="detail-value" id="classDisplay">' + classDisplay + ' <button class="btn-secondary" style="padding: 4px 8px; font-size: 12px; margin-left: 10px;" onclick="showClassEdit()">' + editBtn + '</button></span></div>';
            html += '<div class="detail-row" id="classEditRow" style="display: none;"><span class="detail-label">' + changeClassLabel + ':</span><span class="detail-value"><div class="typeahead-container"><input type="text" id="classInput" placeholder="' + searchClassesPlaceholder + '" autocomplete="off"><div id="classDropdown" class="typeahead-dropdown"></div><input type="hidden" id="classSelect" value=""></div> <button class="btn-primary" style="padding: 4px 12px; font-size: 12px;" onclick="saveClassChange()">' + saveBtn + '</button> <button class="btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="cancelClassEdit()">' + cancelBtn + '</button></span></div>';

            document.getElementById('trainDetails').innerHTML = html;

            // Add keyboard handlers for name input
            const nameInput = document.getElementById('nameInput');
            if (nameInput) {
                nameInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveNameChange();
                    } else if (e.key === 'Escape') {
                        cancelNameEdit();
                    }
                });
            }

            loadTrainClasses();
        }

        async function loadTrainClasses() {
            try {
                const response = await fetch('/api/train-classes');
                allClasses = await response.json();
                setupClassTypeahead();
            } catch (error) {
                console.error('Error loading train classes:', error);
            }
        }

        let classHighlightedIndex = -1;

        function setupClassTypeahead() {
            const input = document.getElementById('classInput');
            const dropdown = document.getElementById('classDropdown');
            const hidden = document.getElementById('classSelect');

            if (!input) return;

            input.addEventListener('focus', function() { showClassDropdown(this.value); });
            input.addEventListener('input', function() {
                classHighlightedIndex = -1;
                hidden.value = '';
                showClassDropdown(this.value);
            });
            input.addEventListener('keydown', function(e) {
                const items = dropdown.querySelectorAll('.typeahead-item[data-id]');
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    classHighlightedIndex = Math.min(classHighlightedIndex + 1, items.length - 1);
                    updateClassHighlight(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    classHighlightedIndex = Math.max(classHighlightedIndex - 1, 0);
                    updateClassHighlight(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (classHighlightedIndex >= 0 && items[classHighlightedIndex]) {
                        items[classHighlightedIndex].click();
                    }
                } else if (e.key === 'Escape') {
                    dropdown.style.display = 'none';
                }
            });

            // Hide dropdown on click outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.typeahead-container')) {
                    dropdown.style.display = 'none';
                }
            });
        }

        function updateClassHighlight(items) {
            items.forEach(function(item, idx) {
                item.classList.toggle('highlighted', idx === classHighlightedIndex);
            });
            if (classHighlightedIndex >= 0 && items[classHighlightedIndex]) {
                items[classHighlightedIndex].scrollIntoView({ block: 'nearest' });
            }
        }

        function showClassDropdown(filter) {
            const dropdown = document.getElementById('classDropdown');
            const filterLower = (filter || '').toLowerCase();

            const filtered = allClasses.filter(function(cls) {
                return cls.name.toLowerCase().includes(filterLower);
            });

            var noClassLabel = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('trains.noClass') : '-- No Class --';
            var noClassesFoundLabel = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('trains.noClassesFound') : 'No classes found';

            // Add "No Class" option at the top
            let html = '<div class="typeahead-item" data-id="" data-name=""><div class="item-name" style="color: var(--text-muted);">' + noClassLabel + '</div></div>';

            if (filtered.length === 0) {
                html += '<div class="typeahead-item" style="color: var(--text-muted);">' + noClassesFoundLabel + '</div>';
            } else {
                html += filtered.map(function(cls) {
                    return '<div class="typeahead-item" data-id="' + cls.id + '" data-name="' + escapeHtml(cls.name) + '">' +
                        '<div class="item-name">' + escapeHtml(cls.name) + '</div></div>';
                }).join('');
            }

            dropdown.innerHTML = html;

            dropdown.querySelectorAll('.typeahead-item[data-id]').forEach(function(item) {
                item.addEventListener('click', function() {
                    document.getElementById('classInput').value = this.dataset.name;
                    document.getElementById('classSelect').value = this.dataset.id;
                    dropdown.style.display = 'none';
                });
            });

            dropdown.style.display = 'block';
        }

        function showNameEdit() {
            document.getElementById('nameEditRow').style.display = 'flex';
            const input = document.getElementById('nameInput');
            input.value = currentTrain ? currentTrain.name : '';
            input.focus();
            input.select();
        }

        function cancelNameEdit() {
            document.getElementById('nameEditRow').style.display = 'none';
        }

        async function saveNameChange() {
            const name = document.getElementById('nameInput').value.trim();
            if (!name) {
                alert('Name cannot be empty');
                return;
            }
            try {
                const response = await fetch('/api/trains/' + trainId, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to update train name');
                }
                // Reload train to show updated name
                loadTrain();
            } catch (error) {
                console.error('Error updating train name:', error);
                alert('Error updating train name: ' + error.message);
            }
        }

        function showClassEdit() {
            document.getElementById('classEditRow').style.display = 'flex';
            // Pre-fill with current class
            const input = document.getElementById('classInput');
            const hidden = document.getElementById('classSelect');
            if (currentTrain && currentTrain.class_id) {
                input.value = currentTrain.class_name || '';
                hidden.value = currentTrain.class_id;
            } else {
                input.value = '';
                hidden.value = '';
            }
            input.focus();
        }

        function cancelClassEdit() {
            document.getElementById('classEditRow').style.display = 'none';
        }

        async function saveClassChange() {
            const classId = document.getElementById('classSelect').value || null;
            try {
                const response = await fetch('/api/trains/' + trainId, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ class_id: classId ? parseInt(classId) : null })
                });
                if (!response.ok) {
                    throw new Error('Failed to update train class');
                }
                // Reload train to show updated class
                loadTrain();
            } catch (error) {
                console.error('Error updating train class:', error);
                alert('Error updating train class: ' + error.message);
            }
        }

        async function loadRoutes() {
            try {
                // Only fetch routes that have this train assigned
                const response = await fetch('/api/trains/' + trainId + '/routes');
                allRoutes = await response.json();

                // If we came from a specific route, check if it's in the list
                // If not, fetch it separately so we can still show context
                if (fromRouteId) {
                    currentRoute = allRoutes.find(function(r) { return r.id == fromRouteId; });
                    if (!currentRoute) {
                        // Route not in train's routes - fetch it separately
                        try {
                            const routeResponse = await fetch('/api/routes/' + fromRouteId);
                            if (routeResponse.ok) {
                                currentRoute = await routeResponse.json();
                                // Add to allRoutes so it appears in the dropdown
                                allRoutes.unshift(currentRoute);
                            }
                        } catch (e) {
                            console.error('Error fetching from_route:', e);
                        }
                    }
                }

                populateRouteFilter();

                // If we have a current route from params, show context and set filter
                if (fromRouteId && currentRoute) {
                    var showingTimetablesMsg = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('trains.showingTimetablesOnRoute') : 'Showing timetables for this train on';
                    var backToLabel = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('common.backTo') : 'Back to';
                    document.getElementById('routeFilter').value = fromRouteId;
                    document.getElementById('routeFilterInput').value = currentRoute.name;
                    document.getElementById('contextInfo').style.display = 'block';
                    document.getElementById('contextInfo').innerHTML = showingTimetablesMsg + ' <a href="/routes/' + currentRoute.id + '">' + escapeHtml(currentRoute.name) + '</a>';
                    document.getElementById('backLink').innerHTML = '<a href="/routes/' + currentRoute.id + '">&larr; ' + backToLabel + ' ' + escapeHtml(currentRoute.name) + '</a>';
                }
            } catch (error) {
                console.error('Error loading routes:', error);
            }
        }

        function populateRouteFilter() {
            setupRouteTypeahead();
        }

        let routeHighlightedIndex = -1;

        function setupRouteTypeahead() {
            const input = document.getElementById('routeFilterInput');
            const dropdown = document.getElementById('routeFilterDropdown');
            const hidden = document.getElementById('routeFilter');

            if (!input) return;

            input.addEventListener('focus', function() { showRouteDropdown(this.value); });
            input.addEventListener('input', function() {
                routeHighlightedIndex = -1;
                hidden.value = '';
                showRouteDropdown(this.value);
            });
            input.addEventListener('keydown', function(e) {
                const items = dropdown.querySelectorAll('.typeahead-item[data-id]');
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    routeHighlightedIndex = Math.min(routeHighlightedIndex + 1, items.length - 1);
                    updateRouteHighlight(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    routeHighlightedIndex = Math.max(routeHighlightedIndex - 1, 0);
                    updateRouteHighlight(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (routeHighlightedIndex >= 0 && items[routeHighlightedIndex]) {
                        items[routeHighlightedIndex].click();
                    }
                } else if (e.key === 'Escape') {
                    dropdown.style.display = 'none';
                }
            });

            // Hide dropdown on click outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#routeFilterInput') && !e.target.closest('#routeFilterDropdown')) {
                    dropdown.style.display = 'none';
                }
            });
        }

        function updateRouteHighlight(items) {
            items.forEach(function(item, idx) {
                item.classList.toggle('highlighted', idx === routeHighlightedIndex);
            });
            if (routeHighlightedIndex >= 0 && items[routeHighlightedIndex]) {
                items[routeHighlightedIndex].scrollIntoView({ block: 'nearest' });
            }
        }

        function showRouteDropdown(filter) {
            const dropdown = document.getElementById('routeFilterDropdown');
            const filterLower = (filter || '').toLowerCase();

            const filtered = allRoutes.filter(function(route) {
                return route.name.toLowerCase().includes(filterLower);
            });

            var allRoutesLabel = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('routes.allRoutes') : '-- All Routes --';
            var noRoutesFoundLabel = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('routes.noRoutesFound') : 'No routes found';

            // Add "All Routes" option at the top
            let html = '<div class="typeahead-item" data-id="" data-name=""><div class="item-name" style="color: var(--text-muted);">' + allRoutesLabel + '</div></div>';

            if (filtered.length === 0) {
                html += '<div class="typeahead-item" style="color: var(--text-muted);">' + noRoutesFoundLabel + '</div>';
            } else {
                html += filtered.map(function(route) {
                    return '<div class="typeahead-item" data-id="' + route.id + '" data-name="' + escapeHtml(route.name) + '">' +
                        '<div class="item-name">' + escapeHtml(route.name) + '</div></div>';
                }).join('');
            }

            dropdown.innerHTML = html;

            dropdown.querySelectorAll('.typeahead-item[data-id]').forEach(function(item) {
                item.addEventListener('click', function() {
                    document.getElementById('routeFilterInput').value = this.dataset.name;
                    document.getElementById('routeFilter').value = this.dataset.id;
                    dropdown.style.display = 'none';
                    filterTimetables();
                });
            });

            dropdown.style.display = 'block';
        }

        function clearRouteFilter() {
            document.getElementById('routeFilterInput').value = '';
            document.getElementById('routeFilter').value = '';
            filterTimetables();
        }

        async function loadTimetables() {
            try {
                const response = await fetch('/api/timetables');
                const timetables = await response.json();
                // Filter to only timetables for this train
                allTimetables = timetables.filter(function(t) { return t.train_id == trainId; });
                renderTimetables();
            } catch (error) {
                console.error('Error loading timetables:', error);
                var errorMsg = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('trains.errorLoadingTimetables') : 'Error loading timetables';
                document.getElementById('timetablesList').innerHTML = '<p class="empty-message">' + errorMsg + '</p>';
            }
        }

        function filterTimetables() {
            const routeId = document.getElementById('routeFilter').value;
            if (routeId) {
                currentRoute = allRoutes.find(function(r) { return r.id == routeId; });
                // Update URL without reloading
                const newUrl = '/trains/' + trainId + '?from_route=' + routeId;
                window.history.replaceState({}, '', newUrl);
                var showingTimetablesMsg = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('trains.showingTimetablesOnRoute') : 'Showing timetables for this train on';
                document.getElementById('contextInfo').style.display = 'block';
                document.getElementById('contextInfo').innerHTML = showingTimetablesMsg + ' <a href="/routes/' + currentRoute.id + '">' + escapeHtml(currentRoute.name) + '</a>';
            } else {
                currentRoute = null;
                window.history.replaceState({}, '', '/trains/' + trainId);
                document.getElementById('contextInfo').style.display = 'none';
            }
            renderTimetables();
        }

        function renderTimetables() {
            const container = document.getElementById('timetablesList');
            let timetables = allTimetables;

            // Filter by selected route
            const routeId = document.getElementById('routeFilter').value;
            if (routeId) {
                timetables = timetables.filter(function(t) { return t.route_id == routeId; });
            }

            var noTimetablesMsg = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('trains.noTimetablesForTrain') : 'No timetables found for this train';
            var noTimetablesOnRouteMsg = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('trains.noTimetablesOnRoute') : 'No timetables found for this train on this route';
            var idHeader = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('common.id') : 'ID';
            var serviceNameHeader = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('timetables.serviceName') : 'Service Name';
            var routeHeader = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('nav.routes') : 'Route';
            var createdHeader = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('common.created') : 'Created';
            var actionsHeader = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('common.actions') : 'Actions';
            var showBtn = (typeof i18n !== 'undefined' && i18n.t) ? i18n.t('common.show') : 'Show';

            if (timetables.length === 0) {
                container.innerHTML = '<p class="empty-message">' + (routeId ? noTimetablesOnRouteMsg : noTimetablesMsg) + '.</p>';
                return;
            }

            let html = '<table><thead><tr><th>' + idHeader + '</th><th>' + serviceNameHeader + '</th><th>' + routeHeader + '</th><th>' + createdHeader + '</th><th class="actions">' + actionsHeader + '</th></tr></thead><tbody>';
            timetables.forEach(function(t) {
                const route = allRoutes.find(function(r) { return r.id == t.route_id; });
                const routeName = route ? route.name : 'Unknown';
                html += '<tr>';
                html += '<td>' + t.id + '</td>';
                html += '<td><a href="/timetables/' + t.id + '" style="color:#00d4ff;text-decoration:none;">' + escapeHtml(t.service_name) + '</a></td>';
                html += '<td>' + (route ? '<a href="/routes/' + route.id + '" style="color:#00d4ff;text-decoration:none;">' + escapeHtml(routeName) + '</a>' : routeName) + '</td>';
                html += '<td>' + (t.created_at || '-') + '</td>';
                html += '<td class="actions"><button class="btn-primary" onclick="showTimetable(' + t.id + ')">' + showBtn + '</button></td>';
                html += '</tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function showTimetable(id) {
            window.location.href = '/timetables/' + id;
        }

        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Theme and color scheme initialization
        (function() {
            var theme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', theme);

            var colorScheme = localStorage.getItem('colorScheme');
            if (colorScheme && colorScheme !== 'default') {
                document.body.setAttribute('data-color-scheme', colorScheme);
            }
        })();

        // Load everything after i18n is ready
        if (typeof i18n !== 'undefined' && i18n.init) {
            i18n.init().then(function() {
                loadTrain();
                loadRoutes().then(loadTimetables);
            });
        } else {
            loadTrain();
            loadRoutes().then(loadTimetables);
        }
    </script>
    <script src="/js/timetable-actions.js"></script>
    <script src="/js/extraction.js"></script>
    <script>
        // Initialize extraction module after train data is loaded
        // We need to wait for the train data to be available for pre-filling
        let extractionInitialized = false;

        function initExtractionWhenReady() {
            if (extractionInitialized) return;
            if (!currentTrain) {
                // Wait for train to load
                setTimeout(initExtractionWhenReady, 100);
                return;
            }

            extractionInitialized = true;

            // Get route info if available
            let prefilledRouteId = fromRouteId || null;
            let prefilledRouteName = null;
            if (prefilledRouteId && allRoutes.length > 0) {
                const route = allRoutes.find(function(r) { return r.id == prefilledRouteId; });
                if (route) {
                    prefilledRouteName = route.name;
                }
            }

            // Initialize the extraction module
            ExtractionModule.init({
                containerId: 'extractionContainer',
                prefilledRouteId: prefilledRouteId,
                prefilledRouteName: prefilledRouteName,
                prefilledTrainId: currentTrain.id,
                prefilledTrainName: currentTrain.name,
                onTimetableCreated: function(result) {
                    console.log('Timetable created:', result);
                }
            });
        }

        // Start checking for train data
        setTimeout(initExtractionWhenReady, 100);
    </script>
    <script src="/js/navbar.js"></script>
</body>
</html>
