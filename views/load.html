<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Load Timetable</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }

        .load-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
            margin-top: 20px;
        }

        .load-panel h2 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 20px;
            border-bottom: 2px solid #0066ff;
            padding-bottom: 10px;
            text-align: center;
        }

        .nav-link {
            display: inline-block;
            color: #0066ff;
            text-decoration: none;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .nav-link:hover {
            text-decoration: underline;
        }

        .route-selector {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .route-selector h3 {
            font-size: 14px;
            color: #333;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .route-selector label {
            font-size: 12px;
            color: #666;
            display: block;
            margin-top: 10px;
            margin-bottom: 4px;
        }

        .route-selector label:first-of-type {
            margin-top: 0;
        }

        .route-selector select,
        .route-selector input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .route-selector button {
            width: 100%;
            margin-top: 12px;
            padding: 12px;
            background: #0066ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .route-selector button:hover {
            background: #0052cc;
        }

        .route-selector button:active {
            background: #003d99;
        }

        .route-selector button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #clearRouteBtn {
            background: #666;
        }

        #clearRouteBtn:hover {
            background: #555;
        }

        #openHudLink {
            display: block;
            margin-top: 12px;
            text-align: center;
            padding: 12px;
            background: #8b5cf6;
            color: white;
            border-radius: 4px;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
        }

        #openHudLink:hover {
            background: #7c3aed;
        }

        .typeahead-container {
            position: relative;
        }

        .typeahead-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            z-index: 1001;
        }

        .typeahead-item {
            padding: 10px 12px;
            cursor: pointer;
            font-size: 13px;
            border-bottom: 1px solid #eee;
        }

        .typeahead-item:last-child {
            border-bottom: none;
        }

        .typeahead-item:hover,
        .typeahead-item.highlighted {
            background: #f0f0f0;
        }

        .typeahead-item .route-name {
            font-weight: 600;
            color: #333;
        }

        .typeahead-item .country-name {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }

        .loaded-info {
            background: #e8f5e9;
            border: 1px solid #a5d6a7;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }

        .loaded-info h3 {
            color: #2e7d32;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .loaded-info p {
            color: #388e3c;
            font-size: 16px;
            font-weight: 600;
            margin: 0;
        }

        .status-message {
            margin-top: 8px;
            font-size: 12px;
            color: #666;
        }

        .status-message.success {
            color: #00cc66;
        }

        .status-message.error {
            color: #ff0000;
        }
    </style>
</head>
<body>
    <div class="load-panel">
        <a href="/" class="nav-link">← Back to Home</a>
        <h2>Load Timetable</h2>

        <div id="loadedInfo" class="loaded-info" style="display: none;">
            <h3>Currently Loaded:</h3>
            <p id="loadedRouteName">-</p>
        </div>

        <div class="route-selector">
            <h3>Select Timetable</h3>

            <label>Route:</label>
            <div class="typeahead-container">
                <input type="text" id="routeInput" placeholder="Type to search routes..." autocomplete="off">
                <div id="routeDropdown" class="typeahead-dropdown" style="display: none;"></div>
                <input type="hidden" id="routeSelect" value="">
            </div>

            <label>Train:</label>
            <select id="trainSelect" onchange="handleTrainChange()" disabled>
                <option value="">-- Select a train --</option>
            </select>

            <label>Timetable:</label>
            <select id="timetableSelect" onchange="handleTimetableChange()" disabled>
                <option value="">-- Select a timetable --</option>
            </select>

            <button id="loadRouteBtn" onclick="loadSelectedTimetable()" disabled>Load Timetable</button>
            <button id="clearRouteBtn" onclick="clearLoadedRoute()" style="display: none;">Clear Loaded Route</button>
            <a href="/hud" id="openHudLink" style="display: none;">Open HUD Screen</a>

            <div class="status-message" id="statusMessage"></div>
        </div>
    </div>

    <script>
        // =============================================
        // Cascading Selectors: Route → Train → Timetable
        // =============================================

        let allRoutes = [];
        let highlightedIndex = -1;

        // Load routes for typeahead
        async function loadRoutes() {
            try {
                const response = await fetch('/api/routes');
                allRoutes = await response.json();
                console.log('Routes loaded:', allRoutes.length);
            } catch (err) {
                console.error('Failed to load routes:', err);
            }
        }

        // Setup typeahead for route input
        function setupRouteTypeahead() {
            const input = document.getElementById('routeInput');
            const dropdown = document.getElementById('routeDropdown');

            input.addEventListener('focus', function() {
                showRouteDropdown(this.value);
            });

            input.addEventListener('input', function() {
                highlightedIndex = -1;
                showRouteDropdown(this.value);
            });

            input.addEventListener('keydown', function(e) {
                const items = dropdown.querySelectorAll('.typeahead-item');

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    highlightedIndex = Math.min(highlightedIndex + 1, items.length - 1);
                    updateHighlight(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    highlightedIndex = Math.max(highlightedIndex - 1, 0);
                    updateHighlight(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (highlightedIndex >= 0 && items[highlightedIndex]) {
                        items[highlightedIndex].click();
                    }
                } else if (e.key === 'Escape') {
                    dropdown.style.display = 'none';
                }
            });

            document.addEventListener('click', function(e) {
                if (!e.target.closest('.typeahead-container')) {
                    dropdown.style.display = 'none';
                }
            });
        }

        function updateHighlight(items) {
            items.forEach((item, idx) => {
                item.classList.toggle('highlighted', idx === highlightedIndex);
            });
            if (highlightedIndex >= 0 && items[highlightedIndex]) {
                items[highlightedIndex].scrollIntoView({ block: 'nearest' });
            }
        }

        function showRouteDropdown(filter) {
            const dropdown = document.getElementById('routeDropdown');
            const filterLower = filter.toLowerCase();

            const filtered = allRoutes.filter(route =>
                route.name.toLowerCase().includes(filterLower) ||
                (route.country_name && route.country_name.toLowerCase().includes(filterLower))
            );

            if (filtered.length === 0) {
                dropdown.innerHTML = '<div class="typeahead-item" style="color: #999;">No routes found</div>';
            } else {
                dropdown.innerHTML = filtered.map(route => `
                    <div class="typeahead-item" data-id="${route.id}" data-name="${route.name}">
                        <div class="route-name">${route.name}</div>
                        ${route.country_name ? `<div class="country-name">${route.country_name}</div>` : ''}
                    </div>
                `).join('');

                dropdown.querySelectorAll('.typeahead-item[data-id]').forEach(item => {
                    item.addEventListener('click', function() {
                        const id = this.dataset.id;
                        const name = this.dataset.name;
                        document.getElementById('routeInput').value = name;
                        document.getElementById('routeSelect').value = id;
                        dropdown.style.display = 'none';
                        handleRouteChange();
                    });
                });
            }

            dropdown.style.display = 'block';
        }

        // Handle route selection - load trains for this route
        async function handleRouteChange() {
            const routeId = document.getElementById('routeSelect').value;
            const trainSelect = document.getElementById('trainSelect');
            const timetableSelect = document.getElementById('timetableSelect');
            const loadBtn = document.getElementById('loadRouteBtn');

            trainSelect.innerHTML = '<option value="">-- Select a train --</option>';
            trainSelect.disabled = true;
            timetableSelect.innerHTML = '<option value="">-- Select a timetable --</option>';
            timetableSelect.disabled = true;
            loadBtn.disabled = true;

            if (!routeId) return;

            try {
                const response = await fetch(`/api/routes/${routeId}/trains`);
                const trains = await response.json();

                if (trains.length > 0) {
                    trainSelect.disabled = false;
                    trains.forEach(train => {
                        const option = document.createElement('option');
                        option.value = train.id;
                        option.textContent = train.name;
                        trainSelect.appendChild(option);
                    });
                }

                console.log('Trains loaded:', trains.length);
            } catch (err) {
                console.error('Failed to load trains:', err);
            }
        }

        // Handle train selection - load timetables for this route+train
        async function handleTrainChange() {
            const routeId = document.getElementById('routeSelect').value;
            const trainId = document.getElementById('trainSelect').value;
            const timetableSelect = document.getElementById('timetableSelect');
            const loadBtn = document.getElementById('loadRouteBtn');

            timetableSelect.innerHTML = '<option value="">-- Select a timetable --</option>';
            timetableSelect.disabled = true;
            loadBtn.disabled = true;

            if (!trainId) return;

            try {
                const response = await fetch(`/api/timetables?route_id=${routeId}&train_id=${trainId}`);
                const timetables = await response.json();

                const withData = timetables.filter(t => t.coordinate_count > 0);

                if (withData.length > 0) {
                    timetableSelect.disabled = false;
                    withData.forEach(tt => {
                        const option = document.createElement('option');
                        option.value = tt.id;
                        option.textContent = `${tt.service_name} (${tt.coordinate_count} pts)`;
                        timetableSelect.appendChild(option);
                    });
                }

                console.log('Timetables with data:', withData.length);
            } catch (err) {
                console.error('Failed to load timetables:', err);
            }
        }

        // Handle timetable selection - enable load button
        function handleTimetableChange() {
            const timetableId = document.getElementById('timetableSelect').value;
            const loadBtn = document.getElementById('loadRouteBtn');

            loadBtn.disabled = !timetableId;
            console.log('Selected timetable:', timetableId);
        }

        // Load selected timetable data from database
        async function loadSelectedTimetable() {
            const timetableId = document.getElementById('timetableSelect').value;
            const statusMessage = document.getElementById('statusMessage');

            if (!timetableId) return;

            statusMessage.textContent = 'Loading...';
            statusMessage.className = 'status-message';

            try {
                const response = await fetch(`/api/map/route-data/${timetableId}`);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                console.log('Route data loaded:', data.routeName);

                // Send to server to set as active route
                const uploadRes = await fetch('/api/upload-route', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filename: `db_timetable_${timetableId}.json`,
                        routeData: data
                    })
                });

                const result = await uploadRes.json();
                if (!result.success) {
                    console.warn('Failed to set route on server:', result.error);
                }

                // Store in localStorage
                localStorage.setItem('customRoute', JSON.stringify(data));
                localStorage.setItem('customRouteFilename', data.routeName);

                // Update UI
                updateLoadedState(data.routeName);

                statusMessage.textContent = 'Timetable loaded successfully!';
                statusMessage.className = 'status-message success';

            } catch (err) {
                console.error('Failed to load timetable:', err);
                statusMessage.textContent = `Error: ${err.message}`;
                statusMessage.className = 'status-message error';
            }
        }

        // Clear loaded route
        async function clearLoadedRoute() {
            const statusMessage = document.getElementById('statusMessage');

            try {
                await fetch('/api/clear-route', { method: 'POST' });

                localStorage.removeItem('customRoute');
                localStorage.removeItem('customRouteFilename');

                document.getElementById('loadedInfo').style.display = 'none';
                document.getElementById('clearRouteBtn').style.display = 'none';
                document.getElementById('openHudLink').style.display = 'none';

                // Reset dropdowns
                document.getElementById('routeInput').value = '';
                document.getElementById('routeSelect').value = '';
                document.getElementById('trainSelect').innerHTML = '<option value="">-- Select a train --</option>';
                document.getElementById('trainSelect').disabled = true;
                document.getElementById('timetableSelect').innerHTML = '<option value="">-- Select a timetable --</option>';
                document.getElementById('timetableSelect').disabled = true;
                document.getElementById('loadRouteBtn').disabled = true;

                statusMessage.textContent = 'Route cleared.';
                statusMessage.className = 'status-message';

            } catch (err) {
                console.error('Failed to clear route:', err);
                statusMessage.textContent = `Error: ${err.message}`;
                statusMessage.className = 'status-message error';
            }
        }

        // Update UI to show loaded state
        function updateLoadedState(routeName) {
            document.getElementById('loadedInfo').style.display = 'block';
            document.getElementById('loadedRouteName').textContent = routeName;
            document.getElementById('clearRouteBtn').style.display = 'block';
            document.getElementById('openHudLink').style.display = 'block';
        }

        // Select timetable in dropdowns by timetable ID
        async function selectTimetableInDropdowns(timetableId) {
            if (!timetableId) return;

            try {
                // Get timetable details to find route_id and train_id
                const response = await fetch(`/api/timetables/${timetableId}`);
                const timetable = await response.json();

                if (!timetable || timetable.error) {
                    console.log('Could not find timetable:', timetableId);
                    return;
                }

                // Wait for routes to load
                while (allRoutes.length === 0) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                // Find and select the route
                const route = allRoutes.find(r => r.id === timetable.route_id);
                if (route) {
                    document.getElementById('routeInput').value = route.name;
                    document.getElementById('routeSelect').value = route.id;

                    // Load trains for this route
                    await handleRouteChange();

                    // Select the train
                    const trainSelect = document.getElementById('trainSelect');
                    trainSelect.value = timetable.train_id;

                    // Load timetables for this route+train
                    await handleTrainChange();

                    // Select the timetable
                    const timetableSelect = document.getElementById('timetableSelect');
                    timetableSelect.value = timetableId;
                    handleTimetableChange();

                    console.log('Dropdowns populated for timetable:', timetableId);
                }
            } catch (err) {
                console.error('Error selecting timetable in dropdowns:', err);
            }
        }

        // Check for existing loaded route on page load
        // First check server, then fall back to localStorage
        async function checkExistingRoute() {
            try {
                // Check server for currently loaded route
                const response = await fetch('/route-data');
                const serverData = await response.json();

                if (serverData && serverData.routeName && !serverData.error) {
                    // Server has a route loaded - use that
                    updateLoadedState(serverData.routeName);

                    // Sync localStorage with server data
                    localStorage.setItem('customRoute', JSON.stringify(serverData));
                    localStorage.setItem('customRouteFilename', serverData.routeName);

                    // Select the timetable in dropdowns
                    if (serverData.timetableId) {
                        await selectTimetableInDropdowns(serverData.timetableId);
                    }
                    return;
                }
            } catch (err) {
                console.log('No route loaded on server');
            }

            // Fall back to localStorage
            const customRoute = localStorage.getItem('customRoute');
            const customRouteFilename = localStorage.getItem('customRouteFilename');

            if (customRoute && customRouteFilename) {
                updateLoadedState(customRouteFilename);

                // Try to select in dropdowns from localStorage data
                try {
                    const data = JSON.parse(customRoute);
                    if (data.timetableId) {
                        await selectTimetableInDropdowns(data.timetableId);
                    }
                } catch (err) {
                    console.log('Could not parse localStorage route data');
                }
            }
        }

        // Initialize
        loadRoutes();
        setupRouteTypeahead();
        checkExistingRoute();

        console.log('Load page initialized');
    </script>
</body>
</html>
