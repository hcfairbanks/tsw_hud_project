<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timetable Details - TSW HUD Project</title>
    <link rel="stylesheet" href="/css/theme.css">
    <style>
        * { box-sizing: border-box; }
        body { font-family: Arial, sans-serif; max-width: 1600px; margin: 0 auto; padding: 20px; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
        h1 { color: var(--accent-color); text-align: center; margin-bottom: 30px; }
        .subtitle { text-align: center; color: var(--text-muted); margin-bottom: 30px; }
        /* Nav styles now in theme.css */
        .card { background: var(--bg-secondary); border-radius: 8px; padding: 20px; margin-bottom: 20px; border: 1px solid var(--border-color); }
        h2 { color: var(--accent-color); margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .detail-row { display: flex; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
        .detail-row:last-child { border-bottom: none; }
        .detail-label { font-weight: bold; color: var(--accent-color); width: 120px; flex-shrink: 0; }
        .detail-value { color: var(--text-primary); flex: 1; }
        .detail-value a { color: var(--accent-color); text-decoration: none; }
        .detail-value a:hover { text-decoration: underline; }
        button { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-right: 5px; }
        .btn-primary { background: var(--btn-primary-bg); color: #fff; }
        .btn-primary:hover { background: var(--btn-primary-hover); }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); }
        .btn-secondary:hover { background: var(--accent-hover); }
        .btn-danger { background: var(--btn-danger-bg); color: #fff; }
        .btn-danger:hover { background: var(--btn-danger-hover); }
        .btn-save { background: var(--btn-success-bg); color: #fff; }
        .btn-save:hover { background: var(--btn-success-hover); }
        .btn-cancel { background: #95a5a6; color: #fff; }
        .btn-cancel:hover { background: #7f8c8d; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; text-align: center; border-bottom: 1px solid var(--border-color); font-size: 14px; }
        th { background: var(--bg-tertiary); color: var(--accent-color); }
        tr:hover { background: var(--bg-primary); }
        .actions { white-space: nowrap; }
        .actions button { padding: 5px 10px; font-size: 12px; }
        .empty-message { text-align: center; color: var(--text-muted); padding: 20px; }
        .back-link { margin-bottom: 20px; }
        .back-link a { color: var(--accent-color); text-decoration: none; }
        .back-link a:hover { text-decoration: underline; }
        .editable-cell { cursor: pointer; position: relative; }
        .editable-cell:hover { background: var(--bg-tertiary); }
        .editable-cell input, .editable-cell select { width: 100%; padding: 5px; border: 1px solid var(--accent-color); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary); font-size: 14px; }
        .action-select { padding: 6px 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary); font-size: 12px; min-width: 140px; }
        .action-select:focus { outline: none; border-color: var(--accent-color); }
        .service-name-input { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary); font-size: 16px; }
        .service-name-input:focus { outline: none; border-color: var(--accent-color); }
        .action-bar { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .unsaved-indicator { color: var(--color-warning); font-size: 12px; margin-left: 10px; }
        .btn-warning { background: var(--btn-warning-bg); color: #1a1a2e; }
        .btn-warning:hover { background: var(--btn-warning-hover); }
        .entries-header { display: flex; align-items: center; gap: 15px; }
        .entries-header h2 { margin-bottom: 0; border-bottom: none; padding-bottom: 0; flex: 1; }
        select { background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color); }
        select:focus { border-color: var(--accent-color); outline: none; }
        label { color: var(--text-secondary); }
        /* Typeahead styles */
        .typeahead-wrapper { position: relative; flex: 1; }
        .typeahead-input { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary); font-size: 16px; }
        .typeahead-input:focus { outline: none; border-color: var(--accent-color); }
        .typeahead-input:disabled { background: var(--bg-tertiary); color: var(--text-muted); cursor: not-allowed; }
        .typeahead-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-primary); border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto; z-index: 100; display: none; }
        .typeahead-dropdown.show { display: block; }
        .typeahead-item { padding: 10px; cursor: pointer; color: var(--text-primary); }
        .typeahead-item:hover, .typeahead-item.active { background: var(--bg-tertiary); color: var(--accent-color); }
        .typeahead-empty { padding: 10px; color: var(--text-muted); font-style: italic; }
        .typeahead-row { display: flex; align-items: center; gap: 10px; }
        .view-link { font-size: 12px; white-space: nowrap; }
        .clear-btn { padding: 5px 10px; font-size: 12px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; }
        .clear-btn:hover { background: var(--btn-danger-bg); color: #fff; }
    </style>
</head>
<body data-theme="dark">
    <h1>Timetable Details</h1>

    <nav class="nav">
        <a href="/countries">Countries</a>
        
        <a href="/">Home</a>
        <a href="/hud">HUD</a>
        <a href="/record">Record Map</a>
        <a href="/routes">Routes</a>
        <a href="/settings">Settings</a>
        <a href="/timetables">Timetables</a>
        <a href="/map">Tracking Map</a>
        <a href="/trains">Trains</a>
        <a href="/weather">Weather</a>
    </nav>

    <div class="back-link">
        <a href="/timetables">&larr; Back to Timetables</a>
    </div>

    <div class="card">
        <h2 id="timetableTitle">Loading...</h2>
        <div id="timetableDetails">
            <p class="empty-message">Loading timetable details...</p>
        </div>
    </div>

    <div class="card">
        <div class="entries-header">
            <h2>Entries <span id="unsavedIndicator" class="unsaved-indicator" style="display:none;">* Unsaved changes</span></h2>
            <button class="btn-warning" id="recordRouteBtn" onclick="goToRecordMap()" style="display:none;">Record Route</button>
        </div>
        <div id="entriesList">
            <p class="empty-message">Loading entries...</p>
        </div>
        <div class="action-bar">
            <button class="btn-primary" onclick="addEntry()">Add Entry</button>
            <button class="btn-save" id="saveBtn" onclick="saveChanges()" disabled>Save All Changes</button>
            <button class="btn-danger" onclick="deleteTimetable()">Delete Timetable</button>
        </div>
    </div>

    <div class="card">
        <h2>Export</h2>
        <div class="action-bar">
            <button class="btn-primary" onclick="exportCSV()">Export CSV</button>
            <button class="btn-secondary" onclick="exportThirdRails()">Export ThirdRails</button>
            <button class="btn-secondary" onclick="exportJSON()">Export JSON (Map)</button>
        </div>
    </div>

    <script>
        const timetableId = window.location.pathname.split('/').pop();
        let timetable = null;
        let entries = [];
        let allRoutes = [];
        let allTrains = [];
        let allCountries = [];
        let hasUnsavedChanges = false;

        const ACTIONS = [
            'WAIT FOR SERVICE',
            'STOP AT LOCATION',
            'LOAD PASSENGERS',
            'UNLOAD PASSENGERS',
            'GO VIA LOCATION',
            'UNCOUPLE VEHICLES',
            'COUPLE TO FORMATION'
        ];

        async function loadData() {
            try {
                const [timetableRes, routesRes, trainsRes, countriesRes] = await Promise.all([
                    fetch('/api/timetables/' + timetableId),
                    fetch('/api/routes'),
                    fetch('/api/trains'),
                    fetch('/api/countries')
                ]);

                if (!timetableRes.ok) {
                    document.getElementById('timetableTitle').textContent = 'Timetable Not Found';
                    document.getElementById('timetableDetails').innerHTML = '<p class="empty-message">The requested timetable could not be found.</p>';
                    return;
                }

                timetable = await timetableRes.json();
                allRoutes = await routesRes.json();
                allTrains = await trainsRes.json();
                allCountries = await countriesRes.json();
                entries = timetable.entries || [];

                renderTimetable();
                renderEntries();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('timetableDetails').innerHTML = '<p class="empty-message">Error loading timetable</p>';
            }
        }

        // Track selected route/train for typeaheads
        let selectedRouteId = null;
        let selectedTrainId = null;
        let routeTrains = []; // Trains available for selected route
        let routeActiveIndex = -1;
        let trainActiveIndex = -1;

        function renderTimetable() {
            document.getElementById('timetableTitle').textContent = timetable.service_name || 'Untitled';
            document.title = (timetable.service_name || 'Timetable') + ' - TSW HUD Project';

            const route = allRoutes.find(function(r) { return r.id == timetable.route_id; });
            const train = allTrains.find(function(t) { return t.id == timetable.train_id; });

            // Initialize selected IDs from timetable
            selectedRouteId = timetable.route_id || null;
            selectedTrainId = timetable.train_id || null;

            let html = '';
            html += '<div class="detail-row"><span class="detail-label">ID:</span><span class="detail-value">' + timetable.id + '</span></div>';
            html += '<div class="detail-row"><span class="detail-label">Service Name:</span><span class="detail-value"><input type="text" class="service-name-input" id="serviceNameInput" value="' + escapeHtml(timetable.service_name || '') + '" onchange="markUnsaved()"></span></div>';

            // Route typeahead
            html += '<div class="detail-row"><span class="detail-label">Route:</span><span class="detail-value typeahead-row">';
            html += '<div class="typeahead-wrapper">';
            html += '<input type="text" class="typeahead-input" id="routeSearch" placeholder="Type to search routes..." autocomplete="off" value="' + (route ? escapeHtml(route.name) : '') + '">';
            html += '<div class="typeahead-dropdown" id="routeDropdown"></div>';
            html += '</div>';
            if (route) html += '<a href="/routes/' + route.id + '" class="view-link" id="routeViewLink">View</a>';
            else html += '<span id="routeViewLink"></span>';
            html += '<button type="button" class="clear-btn" onclick="clearRoute()">Clear</button>';
            html += '</span></div>';

            // Train typeahead
            html += '<div class="detail-row"><span class="detail-label">Train:</span><span class="detail-value typeahead-row">';
            html += '<div class="typeahead-wrapper">';
            html += '<input type="text" class="typeahead-input" id="trainSearch" placeholder="' + (selectedRouteId ? 'Type to search trains...' : 'Select a route first') + '" autocomplete="off" value="' + (train ? escapeHtml(train.name) : '') + '"' + (selectedRouteId ? '' : ' disabled') + '>';
            html += '<div class="typeahead-dropdown" id="trainDropdown"></div>';
            html += '</div>';
            if (train) html += '<a href="/trains/' + train.id + '" class="view-link" id="trainViewLink">View</a>';
            else html += '<span id="trainViewLink"></span>';
            html += '<button type="button" class="clear-btn" onclick="clearTrain()">Clear</button>';
            html += '</span></div>';

            html += '<div class="detail-row"><span class="detail-label">Created:</span><span class="detail-value">' + (timetable.created_at || '-') + '</span></div>';

            document.getElementById('timetableDetails').innerHTML = html;

            // Setup typeahead event handlers
            setupRouteTypeahead();
            setupTrainTypeahead();

            // Load trains for selected route
            if (selectedRouteId) {
                loadRouteTrains(selectedRouteId);
            }
        }

        // Load trains for a specific route
        async function loadRouteTrains(routeId) {
            try {
                const response = await fetch('/api/routes/' + routeId + '/trains');
                routeTrains = await response.json();
            } catch (error) {
                console.error('Error loading route trains:', error);
                routeTrains = [];
            }
        }

        // Route typeahead functions
        function filterRoutes(query) {
            if (!query) return allRoutes.slice(0, 10);
            const lowerQuery = query.toLowerCase();
            return allRoutes.filter(function(r) {
                return r.name.toLowerCase().includes(lowerQuery);
            }).slice(0, 10);
        }

        function renderRouteDropdown(routes) {
            const dropdown = document.getElementById('routeDropdown');
            if (routes.length === 0) {
                dropdown.innerHTML = '<div class="typeahead-empty">No routes found</div>';
            } else {
                dropdown.innerHTML = routes.map(function(route, index) {
                    return '<div class="typeahead-item' + (index === routeActiveIndex ? ' active' : '') + '" data-id="' + route.id + '" data-name="' + escapeHtml(route.name) + '">' + escapeHtml(route.name) + '</div>';
                }).join('');

                dropdown.querySelectorAll('.typeahead-item').forEach(function(item) {
                    item.addEventListener('click', function() {
                        selectRoute(parseInt(item.dataset.id), item.dataset.name);
                    });
                });
            }
            dropdown.classList.add('show');
        }

        async function selectRoute(id, name) {
            const searchInput = document.getElementById('routeSearch');
            const dropdown = document.getElementById('routeDropdown');
            const viewLink = document.getElementById('routeViewLink');
            const trainSearch = document.getElementById('trainSearch');

            searchInput.value = name;
            selectedRouteId = id;
            dropdown.classList.remove('show');
            routeActiveIndex = -1;

            // Update view link
            viewLink.outerHTML = '<a href="/routes/' + id + '" class="view-link" id="routeViewLink">View</a>';

            // Clear train selection when route changes
            clearTrain();

            // Enable train search and load route trains
            trainSearch.disabled = false;
            trainSearch.placeholder = 'Type to search trains...';
            await loadRouteTrains(id);

            markUnsaved();
        }

        function clearRoute() {
            const searchInput = document.getElementById('routeSearch');
            const viewLink = document.getElementById('routeViewLink');
            const trainSearch = document.getElementById('trainSearch');

            searchInput.value = '';
            selectedRouteId = null;
            viewLink.outerHTML = '<span id="routeViewLink"></span>';

            // Clear and disable train
            clearTrain();
            trainSearch.disabled = true;
            trainSearch.placeholder = 'Select a route first';
            routeTrains = [];

            markUnsaved();
        }

        function setupRouteTypeahead() {
            const searchInput = document.getElementById('routeSearch');
            const dropdown = document.getElementById('routeDropdown');

            searchInput.addEventListener('input', function() {
                selectedRouteId = null;
                document.getElementById('routeViewLink').outerHTML = '<span id="routeViewLink"></span>';
                routeActiveIndex = -1;
                const filtered = filterRoutes(searchInput.value.trim());
                renderRouteDropdown(filtered);

                // Clear and disable train when route is being edited
                clearTrain();
                document.getElementById('trainSearch').disabled = true;
                document.getElementById('trainSearch').placeholder = 'Select a route first';
                routeTrains = [];

                markUnsaved();
            });

            searchInput.addEventListener('focus', function() {
                const filtered = filterRoutes(searchInput.value.trim());
                renderRouteDropdown(filtered);
            });

            searchInput.addEventListener('keydown', function(e) {
                const items = dropdown.querySelectorAll('.typeahead-item');
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    routeActiveIndex = Math.min(routeActiveIndex + 1, items.length - 1);
                    updateActiveRouteItem(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    routeActiveIndex = Math.max(routeActiveIndex - 1, 0);
                    updateActiveRouteItem(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (routeActiveIndex >= 0 && items[routeActiveIndex]) {
                        selectRoute(parseInt(items[routeActiveIndex].dataset.id), items[routeActiveIndex].dataset.name);
                    }
                } else if (e.key === 'Escape') {
                    dropdown.classList.remove('show');
                    routeActiveIndex = -1;
                }
            });
        }

        function updateActiveRouteItem(items) {
            items.forEach(function(item, index) {
                if (index === routeActiveIndex) {
                    item.classList.add('active');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // Train typeahead functions
        function filterTrains(query) {
            if (!query) return routeTrains.slice(0, 10);
            const lowerQuery = query.toLowerCase();
            return routeTrains.filter(function(t) {
                return t.name.toLowerCase().includes(lowerQuery);
            }).slice(0, 10);
        }

        function renderTrainDropdown(trains) {
            const dropdown = document.getElementById('trainDropdown');
            if (trains.length === 0) {
                dropdown.innerHTML = '<div class="typeahead-empty">No trains found for this route</div>';
            } else {
                dropdown.innerHTML = trains.map(function(train, index) {
                    return '<div class="typeahead-item' + (index === trainActiveIndex ? ' active' : '') + '" data-id="' + train.id + '" data-name="' + escapeHtml(train.name) + '">' + escapeHtml(train.name) + '</div>';
                }).join('');

                dropdown.querySelectorAll('.typeahead-item').forEach(function(item) {
                    item.addEventListener('click', function() {
                        selectTrain(parseInt(item.dataset.id), item.dataset.name);
                    });
                });
            }
            dropdown.classList.add('show');
        }

        function selectTrain(id, name) {
            const searchInput = document.getElementById('trainSearch');
            const dropdown = document.getElementById('trainDropdown');
            const viewLink = document.getElementById('trainViewLink');

            searchInput.value = name;
            selectedTrainId = id;
            dropdown.classList.remove('show');
            trainActiveIndex = -1;

            // Update view link
            viewLink.outerHTML = '<a href="/trains/' + id + '" class="view-link" id="trainViewLink">View</a>';

            markUnsaved();
        }

        function clearTrain() {
            const searchInput = document.getElementById('trainSearch');
            const viewLink = document.getElementById('trainViewLink');

            searchInput.value = '';
            selectedTrainId = null;
            viewLink.outerHTML = '<span id="trainViewLink"></span>';

            markUnsaved();
        }

        function setupTrainTypeahead() {
            const searchInput = document.getElementById('trainSearch');
            const dropdown = document.getElementById('trainDropdown');

            searchInput.addEventListener('input', function() {
                selectedTrainId = null;
                document.getElementById('trainViewLink').outerHTML = '<span id="trainViewLink"></span>';
                trainActiveIndex = -1;
                const filtered = filterTrains(searchInput.value.trim());
                renderTrainDropdown(filtered);
                markUnsaved();
            });

            searchInput.addEventListener('focus', function() {
                if (!searchInput.disabled) {
                    const filtered = filterTrains(searchInput.value.trim());
                    renderTrainDropdown(filtered);
                }
            });

            searchInput.addEventListener('keydown', function(e) {
                const items = dropdown.querySelectorAll('.typeahead-item');
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    trainActiveIndex = Math.min(trainActiveIndex + 1, items.length - 1);
                    updateActiveTrainItem(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    trainActiveIndex = Math.max(trainActiveIndex - 1, 0);
                    updateActiveTrainItem(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (trainActiveIndex >= 0 && items[trainActiveIndex]) {
                        selectTrain(parseInt(items[trainActiveIndex].dataset.id), items[trainActiveIndex].dataset.name);
                    }
                } else if (e.key === 'Escape') {
                    dropdown.classList.remove('show');
                    trainActiveIndex = -1;
                }
            });
        }

        function updateActiveTrainItem(items) {
            items.forEach(function(item, index) {
                if (index === trainActiveIndex) {
                    item.classList.add('active');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.typeahead-wrapper')) {
                const routeDropdown = document.getElementById('routeDropdown');
                const trainDropdown = document.getElementById('trainDropdown');
                if (routeDropdown) routeDropdown.classList.remove('show');
                if (trainDropdown) trainDropdown.classList.remove('show');
                routeActiveIndex = -1;
                trainActiveIndex = -1;
            }
        });

        function renderEntries() {
            const container = document.getElementById('entriesList');

            if (entries.length === 0) {
                container.innerHTML = '<p class="empty-message">No entries in this timetable.</p>';
                updateRecordRouteButton();
                return;
            }

            let html = '<table><thead><tr><th>#</th><th>Action</th><th>Location</th><th>Platform</th><th>Time 1</th><th>Time 2</th><th>Details</th><th class="actions">Actions</th></tr></thead><tbody>';
            entries.forEach(function(entry, index) {
                var actionOptions = ACTIONS.map(function(a) {
                    return '<option value="' + a + '"' + (entry.action === a ? ' selected' : '') + '>' + a + '</option>';
                }).join('');

                html += '<tr data-index="' + index + '" data-id="' + (entry.id || '') + '">';
                html += '<td>' + (index + 1) + '</td>';
                html += '<td><select class="action-select" onchange="updateEntryField(' + index + ', \'action\', this.value)"><option value="">-- Select --</option>' + actionOptions + '</select></td>';
                html += '<td class="editable-cell" data-field="location">' + escapeHtml(entry.location || '') + '</td>';
                html += '<td class="editable-cell" data-field="platform">' + escapeHtml(entry.platform || '') + '</td>';
                html += '<td class="editable-cell" data-field="time1">' + escapeHtml(entry.time1 || '') + '</td>';
                html += '<td class="editable-cell" data-field="time2">' + escapeHtml(entry.time2 || '') + '</td>';
                html += '<td class="editable-cell" data-field="details">' + escapeHtml(entry.details || '') + '</td>';
                html += '<td class="actions">';
                if (index > 0) html += '<button class="btn-secondary" onclick="moveEntry(' + index + ', -1)">Up</button>';
                if (index < entries.length - 1) html += '<button class="btn-secondary" onclick="moveEntry(' + index + ', 1)">Down</button>';
                html += '<button class="btn-danger" onclick="deleteEntry(' + index + ')">Delete</button>';
                html += '</td></tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;

            // Add click handlers for editable cells
            document.querySelectorAll('#entriesList .editable-cell').forEach(function(cell) {
                cell.addEventListener('click', makeCellEditable);
            });

            updateRecordRouteButton();
        }

        function updateRecordRouteButton() {
            // Show Record Route button only if no entries have valid coordinates
            const hasCoordinates = entries.some(function(entry) {
                // Check for actual numeric coordinates (not null, undefined, empty string, or 0)
                const lat = parseFloat(entry.latitude);
                const lng = parseFloat(entry.longitude);
                return !isNaN(lat) && !isNaN(lng) && (lat !== 0 || lng !== 0);
            });
            const btn = document.getElementById('recordRouteBtn');
            btn.style.display = hasCoordinates ? 'none' : 'inline-block';
        }

        function updateEntryField(index, field, value) {
            entries[index][field] = value;
            markUnsaved();
        }

        function makeCellEditable(e) {
            var cell = e.target;
            if (cell.querySelector('input')) return;

            var currentValue = cell.textContent;
            var field = cell.dataset.field;
            var row = cell.parentElement;
            var index = parseInt(row.dataset.index);

            var input = document.createElement('input');
            input.type = 'text';
            input.value = currentValue;

            input.addEventListener('blur', function() {
                var newValue = input.value;
                entries[index][field] = newValue;
                cell.textContent = newValue;
                markUnsaved();
            });

            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    input.blur();
                } else if (e.key === 'Escape') {
                    cell.textContent = currentValue;
                }
            });

            cell.textContent = '';
            cell.appendChild(input);
            input.focus();
            input.select();
        }

        function addEntry() {
            entries.push({
                action: 'STOP AT LOCATION',
                details: '',
                location: '',
                platform: '',
                time1: '',
                time2: '',
                latitude: '',
                longitude: '',
                sort_order: entries.length,
                isNew: true
            });
            renderEntries();
            markUnsaved();
        }

        function deleteEntry(index) {
            if (!confirm('Delete this entry?')) return;
            entries.splice(index, 1);
            // Update sort_order
            entries.forEach(function(entry, i) { entry.sort_order = i; });
            renderEntries();
            markUnsaved();
        }

        function moveEntry(index, direction) {
            var newIndex = index + direction;
            if (newIndex < 0 || newIndex >= entries.length) return;

            var temp = entries[index];
            entries[index] = entries[newIndex];
            entries[newIndex] = temp;

            // Update sort_order
            entries.forEach(function(entry, i) { entry.sort_order = i; });
            renderEntries();
            markUnsaved();
        }

        function markUnsaved() {
            hasUnsavedChanges = true;
            document.getElementById('unsavedIndicator').style.display = 'inline';
            document.getElementById('saveBtn').disabled = false;
        }

        function markSaved() {
            hasUnsavedChanges = false;
            document.getElementById('unsavedIndicator').style.display = 'none';
            document.getElementById('saveBtn').disabled = true;
        }

        async function saveChanges() {
            try {
                // Update timetable service name, route, and train
                const serviceName = document.getElementById('serviceNameInput').value.trim();

                const updateData = {
                    service_name: serviceName,
                    route_id: selectedRouteId,
                    train_id: selectedTrainId
                };

                const updateRes = await fetch('/api/timetables/' + timetableId, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });

                const updatedTimetable = await updateRes.json();
                timetable = { ...timetable, ...updatedTimetable };

                // Update/create/delete entries
                for (var i = 0; i < entries.length; i++) {
                    var entry = entries[i];
                    if (entry.isNew) {
                        // Create new entry
                        var createRes = await fetch('/api/timetables/' + timetableId + '/entries', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(entry)
                        });
                        var created = await createRes.json();
                        entries[i].id = created.id;
                        delete entries[i].isNew;
                    } else if (entry.id) {
                        // Update existing entry
                        await fetch('/api/entries/' + entry.id, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(entry)
                        });
                    }
                }

                // Update title and re-render to show updated View links
                document.getElementById('timetableTitle').textContent = serviceName || 'Untitled';
                renderTimetable();

                markSaved();
                alert('Changes saved successfully!');
            } catch (error) {
                console.error('Error saving changes:', error);
                alert('Error saving changes: ' + error.message);
            }
        }

        async function deleteTimetable() {
            if (!confirm('Are you sure you want to delete this timetable and all its entries?')) return;
            try {
                await fetch('/api/timetables/' + timetableId, { method: 'DELETE' });
                window.location.href = '/timetables';
            } catch (error) {
                console.error('Error deleting timetable:', error);
                alert('Error deleting timetable');
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeCSV(text) {
            if (!text) return '';
            // If contains comma, quote, or newline, wrap in quotes and escape quotes
            if (text.indexOf(',') >= 0 || text.indexOf('"') >= 0 || text.indexOf('\n') >= 0) {
                return '"' + text.replace(/"/g, '""') + '"';
            }
            return text;
        }

        function sanitizeFilename(name) {
            // Collapse multiple spaces into single space and trim
            return name.replace(/\s+/g, ' ').trim();
        }

        function downloadCSV(content, filename) {
            var blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            URL.revokeObjectURL(link.href);
        }

        function exportCSV() {
            if (entries.length === 0) {
                alert('No entries to export');
                return;
            }

            var lines = ['Action,Location,Platform,Time1,Time2,Details,Latitude,Longitude'];

            entries.forEach(function(entry) {
                var action = entry.action || '';
                var location = entry.location || '';
                var platform = entry.platform || '';
                var time1 = entry.time1 || '';
                var time2 = entry.time2 || '';
                var details = entry.details || '';
                var latitude = (entry.latitude !== null && entry.latitude !== undefined) ? String(entry.latitude) : '';
                var longitude = (entry.longitude !== null && entry.longitude !== undefined) ? String(entry.longitude) : '';

                lines.push([
                    escapeCSV(action),
                    escapeCSV(location),
                    escapeCSV(platform),
                    escapeCSV(time1),
                    escapeCSV(time2),
                    escapeCSV(details),
                    escapeCSV(latitude),
                    escapeCSV(longitude)
                ].join(','));
            });

            var filename = sanitizeFilename(timetable.service_name || 'timetable') + '.csv';
            downloadCSV(lines.join('\n'), filename);
        }

        function exportThirdRails() {
            if (entries.length === 0) {
                alert('No entries to export');
                return;
            }

            var lines = ['Destination,Arrival,Departure,Platform'];
            var combinedRows = [];

            // Combine STOP/WAIT entries with following LOAD PASSENGERS
            for (var i = 0; i < entries.length; i++) {
                var entry = entries[i];
                var action = entry.action || '';

                if (action === 'WAIT FOR SERVICE' || action === 'STOP AT LOCATION') {
                    var row = {
                        destination: entry.location || '',
                        arrival: entry.time2 || entry.time1 || '',
                        departure: '',
                        platform: entry.platform || ''
                    };

                    // For WAIT FOR SERVICE, arrival is time2 (or time1)
                    if (action === 'WAIT FOR SERVICE') {
                        row.arrival = entry.time2 || entry.time1 || '';
                    } else {
                        row.arrival = entry.time1 || '';
                    }

                    // Look for following LOAD PASSENGERS to get departure time
                    if (i + 1 < entries.length) {
                        var nextEntry = entries[i + 1];
                        if (nextEntry.action === 'LOAD PASSENGERS') {
                            row.departure = nextEntry.time1 || '';
                            i++; // Skip the LOAD PASSENGERS entry
                        }
                    }

                    combinedRows.push(row);
                } else if (action === 'UNLOAD PASSENGERS') {
                    // Find previous STOP entry to get location
                    var prevEntry = i > 0 ? entries[i - 1] : null;
                    if (prevEntry && prevEntry.action === 'STOP AT LOCATION') {
                        // Already handled with the STOP
                    } else {
                        // Standalone UNLOAD - use its own data
                        combinedRows.push({
                            destination: entry.location || '',
                            arrival: entry.time1 || '',
                            departure: '',
                            platform: entry.platform || ''
                        });
                    }
                }
            }

            combinedRows.forEach(function(row) {
                lines.push([
                    escapeCSV(row.destination),
                    escapeCSV(row.arrival),
                    escapeCSV(row.departure),
                    escapeCSV(row.platform)
                ].join(','));
            });

            var filename = sanitizeFilename(timetable.service_name || 'timetable') + '_thirdrails.csv';
            downloadCSV(lines.join('\n'), filename);
        }

        function exportJSON() {
            // Trigger download via the export/download endpoint
            window.location.href = '/api/timetables/' + timetableId + '/export/download';
        }

        function goToRecordMap() {
            window.location.href = '/record?timetable_id=' + timetableId;
        }

        // Warn before leaving with unsaved changes
        window.addEventListener('beforeunload', function(e) {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // Theme initialization
        (function() {
            var theme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', theme);
        })();

        loadData();
    </script>
</body>
</html>
