<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Train Details - TSW HUD Project</title>
    <link rel="stylesheet" href="/css/theme.css">
    <style>
        * { box-sizing: border-box; }
        body { font-family: Arial, sans-serif; max-width: 1600px; margin: 0 auto; padding: 20px; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
        h1 { color: var(--accent-color); text-align: center; margin-bottom: 30px; }
        .subtitle { text-align: center; color: var(--text-muted); margin-bottom: 30px; }
        /* Nav styles now in theme.css */
        .card { background: var(--bg-secondary); border-radius: 8px; padding: 20px; margin-bottom: 20px; border: 1px solid var(--border-color); }
        h2 { color: var(--accent-color); margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .detail-row { display: flex; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
        .detail-row:last-child { border-bottom: none; }
        .detail-label { font-weight: bold; color: var(--accent-color); width: 120px; flex-shrink: 0; }
        .detail-value { color: var(--text-primary); }
        button { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-right: 5px; }
        .btn-primary { background: var(--btn-primary-bg); color: #fff; }
        .btn-primary:hover { background: var(--btn-primary-hover); }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); }
        .btn-secondary:hover { background: var(--accent-hover); }
        .btn-danger { background: var(--btn-danger-bg); color: #fff; }
        .btn-danger:hover { background: var(--btn-danger-hover); }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background: var(--bg-tertiary); color: var(--accent-color); }
        tr:hover { background: var(--bg-primary); }
        .empty-message { text-align: center; color: var(--text-muted); padding: 20px; }
        .back-link { margin-bottom: 20px; }
        .back-link a { color: var(--accent-color); text-decoration: none; }
        .back-link a:hover { text-decoration: underline; }
        .filter-box { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
        .filter-box label { color: var(--text-secondary); white-space: nowrap; }
        .filter-box select { flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary); font-size: 14px; }
        .filter-box select:focus { outline: none; border-color: var(--accent-color); }
        .context-info { background: var(--bg-tertiary); padding: 10px 15px; border-radius: 4px; margin-bottom: 15px; color: var(--text-secondary); }
        .context-info a { color: var(--accent-color); text-decoration: none; }
        .context-info a:hover { text-decoration: underline; }
        a { color: var(--accent-color); }
        .typeahead-container { position: relative; display: inline-block; min-width: 200px; }
        .typeahead-container input { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary); font-size: 14px; }
        .typeahead-container input:focus { outline: none; border-color: var(--accent-color); }
        .typeahead-dropdown { display: none; position: absolute; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; background: var(--bg-secondary); border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 4px 4px; z-index: 1001; }
        .typeahead-item { padding: 8px 12px; cursor: pointer; font-size: 13px; border-bottom: 1px solid var(--border-color); }
        .typeahead-item:last-child { border-bottom: none; }
        .typeahead-item:hover, .typeahead-item.highlighted { background: var(--bg-tertiary); }
        .typeahead-item .item-name { color: var(--text-primary); }
    </style>
</head>
<body data-theme="dark">
    <h1>Train Details</h1>

    <nav class="nav">
        <a href="/countries">Countries</a>
        <a href="/">Home</a>
        <a href="/hud">HUD</a>
        <a href="/record">Record Map</a>
        <a href="/routes">Routes</a>
        <a href="/settings">Settings</a>
        <a href="/timetables">Timetables</a>
        <a href="/map">Tracking Map</a>
        <a href="/train-classes">Train Classes</a>
        <a href="/trains">Trains</a>
        <a href="/weather">Weather</a>
    </nav>

    <div class="back-link" id="backLink">
        <a href="/trains">&larr; Back to Trains</a>
    </div>

    <div class="card">
        <h2 id="trainName">Loading...</h2>
        <div id="trainDetails">
            <p class="empty-message">Loading train details...</p>
        </div>
    </div>

    <div class="card">
        <h2>Timetables</h2>
        <div id="contextInfo" class="context-info" style="display:none;"></div>
        <div class="filter-box">
            <label for="routeFilter">Filter by Route:</label>
            <select id="routeFilter" onchange="filterTimetables()">
                <option value="">All Routes</option>
            </select>
        </div>
        <div id="timetablesList">
            <p class="empty-message">Loading timetables...</p>
        </div>
    </div>

    <script>
        const trainId = window.location.pathname.split('/').pop();
        const urlParams = new URLSearchParams(window.location.search);
        const fromRouteId = urlParams.get('from_route');

        let allTimetables = [];
        let allRoutes = [];
        let currentRoute = null;

        async function loadTrain() {
            try {
                const response = await fetch('/api/trains/' + trainId);
                if (!response.ok) {
                    document.getElementById('trainName').textContent = 'Train Not Found';
                    document.getElementById('trainDetails').innerHTML = '<p class="empty-message">The requested train could not be found.</p>';
                    return;
                }
                const train = await response.json();
                renderTrain(train);
            } catch (error) {
                console.error('Error loading train:', error);
                document.getElementById('trainDetails').innerHTML = '<p class="empty-message">Error loading train</p>';
            }
        }

        let currentTrain = null;
        let allClasses = [];

        function renderTrain(train) {
            currentTrain = train;
            document.getElementById('trainName').textContent = train.name;
            document.title = train.name + ' - TSW HUD Project';

            let classDisplay = '-';
            if (train.class_id && train.class_name) {
                classDisplay = '<a href="/train-classes/' + train.class_id + '">' + escapeHtml(train.class_name) + '</a>';
            }

            let html = '<div class="detail-row"><span class="detail-label">ID:</span><span class="detail-value">' + train.id + '</span></div>';
            html += '<div class="detail-row"><span class="detail-label">Name:</span><span class="detail-value" id="nameDisplay">' + escapeHtml(train.name) + ' <button class="btn-secondary" style="padding: 4px 8px; font-size: 12px; margin-left: 10px;" onclick="showNameEdit()">Edit</button></span></div>';
            html += '<div class="detail-row" id="nameEditRow" style="display: none;"><span class="detail-label">Change Name:</span><span class="detail-value"><input type="text" id="nameInput" style="padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary); font-size: 14px; min-width: 200px;" placeholder="Enter train name..."> <button class="btn-primary" style="padding: 4px 12px; font-size: 12px;" onclick="saveNameChange()">Save</button> <button class="btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="cancelNameEdit()">Cancel</button></span></div>';
            html += '<div class="detail-row"><span class="detail-label">Class:</span><span class="detail-value" id="classDisplay">' + classDisplay + ' <button class="btn-secondary" style="padding: 4px 8px; font-size: 12px; margin-left: 10px;" onclick="showClassEdit()">Edit</button></span></div>';
            html += '<div class="detail-row" id="classEditRow" style="display: none;"><span class="detail-label">Change Class:</span><span class="detail-value"><div class="typeahead-container"><input type="text" id="classInput" placeholder="Type to search classes..." autocomplete="off"><div id="classDropdown" class="typeahead-dropdown"></div><input type="hidden" id="classSelect" value=""></div> <button class="btn-primary" style="padding: 4px 12px; font-size: 12px;" onclick="saveClassChange()">Save</button> <button class="btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="cancelClassEdit()">Cancel</button></span></div>';

            document.getElementById('trainDetails').innerHTML = html;

            // Add keyboard handlers for name input
            const nameInput = document.getElementById('nameInput');
            if (nameInput) {
                nameInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveNameChange();
                    } else if (e.key === 'Escape') {
                        cancelNameEdit();
                    }
                });
            }

            loadTrainClasses();
        }

        async function loadTrainClasses() {
            try {
                const response = await fetch('/api/train-classes');
                allClasses = await response.json();
                setupClassTypeahead();
            } catch (error) {
                console.error('Error loading train classes:', error);
            }
        }

        let classHighlightedIndex = -1;

        function setupClassTypeahead() {
            const input = document.getElementById('classInput');
            const dropdown = document.getElementById('classDropdown');
            const hidden = document.getElementById('classSelect');

            if (!input) return;

            input.addEventListener('focus', function() { showClassDropdown(this.value); });
            input.addEventListener('input', function() {
                classHighlightedIndex = -1;
                hidden.value = '';
                showClassDropdown(this.value);
            });
            input.addEventListener('keydown', function(e) {
                const items = dropdown.querySelectorAll('.typeahead-item[data-id]');
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    classHighlightedIndex = Math.min(classHighlightedIndex + 1, items.length - 1);
                    updateClassHighlight(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    classHighlightedIndex = Math.max(classHighlightedIndex - 1, 0);
                    updateClassHighlight(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (classHighlightedIndex >= 0 && items[classHighlightedIndex]) {
                        items[classHighlightedIndex].click();
                    }
                } else if (e.key === 'Escape') {
                    dropdown.style.display = 'none';
                }
            });

            // Hide dropdown on click outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.typeahead-container')) {
                    dropdown.style.display = 'none';
                }
            });
        }

        function updateClassHighlight(items) {
            items.forEach(function(item, idx) {
                item.classList.toggle('highlighted', idx === classHighlightedIndex);
            });
            if (classHighlightedIndex >= 0 && items[classHighlightedIndex]) {
                items[classHighlightedIndex].scrollIntoView({ block: 'nearest' });
            }
        }

        function showClassDropdown(filter) {
            const dropdown = document.getElementById('classDropdown');
            const filterLower = (filter || '').toLowerCase();

            const filtered = allClasses.filter(function(cls) {
                return cls.name.toLowerCase().includes(filterLower);
            });

            // Add "No Class" option at the top
            let html = '<div class="typeahead-item" data-id="" data-name=""><div class="item-name" style="color: var(--text-muted);">-- No Class --</div></div>';

            if (filtered.length === 0) {
                html += '<div class="typeahead-item" style="color: var(--text-muted);">No classes found</div>';
            } else {
                html += filtered.map(function(cls) {
                    return '<div class="typeahead-item" data-id="' + cls.id + '" data-name="' + escapeHtml(cls.name) + '">' +
                        '<div class="item-name">' + escapeHtml(cls.name) + '</div></div>';
                }).join('');
            }

            dropdown.innerHTML = html;

            dropdown.querySelectorAll('.typeahead-item[data-id]').forEach(function(item) {
                item.addEventListener('click', function() {
                    document.getElementById('classInput').value = this.dataset.name;
                    document.getElementById('classSelect').value = this.dataset.id;
                    dropdown.style.display = 'none';
                });
            });

            dropdown.style.display = 'block';
        }

        function showNameEdit() {
            document.getElementById('nameEditRow').style.display = 'flex';
            const input = document.getElementById('nameInput');
            input.value = currentTrain ? currentTrain.name : '';
            input.focus();
            input.select();
        }

        function cancelNameEdit() {
            document.getElementById('nameEditRow').style.display = 'none';
        }

        async function saveNameChange() {
            const name = document.getElementById('nameInput').value.trim();
            if (!name) {
                alert('Name cannot be empty');
                return;
            }
            try {
                const response = await fetch('/api/trains/' + trainId, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to update train name');
                }
                // Reload train to show updated name
                loadTrain();
            } catch (error) {
                console.error('Error updating train name:', error);
                alert('Error updating train name: ' + error.message);
            }
        }

        function showClassEdit() {
            document.getElementById('classEditRow').style.display = 'flex';
            // Pre-fill with current class
            const input = document.getElementById('classInput');
            const hidden = document.getElementById('classSelect');
            if (currentTrain && currentTrain.class_id) {
                input.value = currentTrain.class_name || '';
                hidden.value = currentTrain.class_id;
            } else {
                input.value = '';
                hidden.value = '';
            }
            input.focus();
        }

        function cancelClassEdit() {
            document.getElementById('classEditRow').style.display = 'none';
        }

        async function saveClassChange() {
            const classId = document.getElementById('classSelect').value || null;
            try {
                const response = await fetch('/api/trains/' + trainId, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ class_id: classId ? parseInt(classId) : null })
                });
                if (!response.ok) {
                    throw new Error('Failed to update train class');
                }
                // Reload train to show updated class
                loadTrain();
            } catch (error) {
                console.error('Error updating train class:', error);
                alert('Error updating train class: ' + error.message);
            }
        }

        async function loadRoutes() {
            try {
                // Only fetch routes that have this train assigned
                const response = await fetch('/api/trains/' + trainId + '/routes');
                allRoutes = await response.json();
                populateRouteFilter();

                // If we came from a specific route, show context and set filter
                if (fromRouteId) {
                    currentRoute = allRoutes.find(function(r) { return r.id == fromRouteId; });
                    if (currentRoute) {
                        document.getElementById('routeFilter').value = fromRouteId;
                        document.getElementById('contextInfo').style.display = 'block';
                        document.getElementById('contextInfo').innerHTML = 'Showing timetables for this train on <a href="/routes/' + currentRoute.id + '">' + escapeHtml(currentRoute.name) + '</a>';
                        document.getElementById('backLink').innerHTML = '<a href="/routes/' + currentRoute.id + '">&larr; Back to ' + escapeHtml(currentRoute.name) + '</a>';

                        // Show Record Route link
                        document.getElementById('recordRouteBtn').style.display = 'inline-block';
                        document.getElementById('recordRouteBtn').href = '/record?route_id=' + fromRouteId + '&train_id=' + trainId;
                    }
                }
            } catch (error) {
                console.error('Error loading routes:', error);
            }
        }

        function populateRouteFilter() {
            const select = document.getElementById('routeFilter');
            allRoutes.forEach(function(route) {
                const option = document.createElement('option');
                option.value = route.id;
                option.textContent = route.name;
                select.appendChild(option);
            });
        }

        async function loadTimetables() {
            try {
                const response = await fetch('/api/timetables');
                const timetables = await response.json();
                // Filter to only timetables for this train
                allTimetables = timetables.filter(function(t) { return t.train_id == trainId; });
                renderTimetables();
            } catch (error) {
                console.error('Error loading timetables:', error);
                document.getElementById('timetablesList').innerHTML = '<p class="empty-message">Error loading timetables</p>';
            }
        }

        function filterTimetables() {
            const routeId = document.getElementById('routeFilter').value;
            if (routeId) {
                currentRoute = allRoutes.find(function(r) { return r.id == routeId; });
                // Update URL without reloading
                const newUrl = '/trains/' + trainId + '?from_route=' + routeId;
                window.history.replaceState({}, '', newUrl);
                document.getElementById('contextInfo').style.display = 'block';
                document.getElementById('contextInfo').innerHTML = 'Showing timetables for this train on <a href="/routes/' + currentRoute.id + '">' + escapeHtml(currentRoute.name) + '</a>';
            } else {
                currentRoute = null;
                window.history.replaceState({}, '', '/trains/' + trainId);
                document.getElementById('contextInfo').style.display = 'none';
            }
            renderTimetables();
        }

        function renderTimetables() {
            const container = document.getElementById('timetablesList');
            let timetables = allTimetables;

            // Filter by selected route
            const routeId = document.getElementById('routeFilter').value;
            if (routeId) {
                timetables = timetables.filter(function(t) { return t.route_id == routeId; });
            }

            if (timetables.length === 0) {
                container.innerHTML = '<p class="empty-message">No timetables found for this train' + (routeId ? ' on this route' : '') + '.</p>';
                return;
            }

            let html = '<table><thead><tr><th>ID</th><th>Service Name</th><th>Route</th><th>Created</th><th class="actions">Actions</th></tr></thead><tbody>';
            timetables.forEach(function(t) {
                const route = allRoutes.find(function(r) { return r.id == t.route_id; });
                const routeName = route ? route.name : 'Unknown';
                html += '<tr>';
                html += '<td>' + t.id + '</td>';
                html += '<td><a href="/timetables/' + t.id + '" style="color:#00d4ff;text-decoration:none;">' + escapeHtml(t.service_name) + '</a></td>';
                html += '<td>' + (route ? '<a href="/routes/' + route.id + '" style="color:#00d4ff;text-decoration:none;">' + escapeHtml(routeName) + '</a>' : routeName) + '</td>';
                html += '<td>' + (t.created_at || '-') + '</td>';
                html += '<td class="actions"><button class="btn-primary" onclick="showTimetable(' + t.id + ')">Show</button></td>';
                html += '</tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function showTimetable(id) {
            window.location.href = '/timetables/' + id;
        }

        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Theme and color scheme initialization
        (function() {
            var theme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', theme);

            var colorScheme = localStorage.getItem('colorScheme');
            if (colorScheme && colorScheme !== 'default') {
                document.body.setAttribute('data-color-scheme', colorScheme);
            }
        })();

        // Load everything
        loadTrain();
        loadRoutes().then(loadTimetables);
    </script>
</body>
</html>
